{
  "name" : "1702.07121.pdf",
  "metadata" : {
    "source" : "META",
    "title" : "Consistent On-Line Off-Policy Evaluation",
    "authors" : [ "Assaf Hallak", "Shie Mannor" ],
    "emails" : [ "<ifogph@gmail.com>,", "<shie@ee.technion.ac.il>." ],
    "sections" : [ {
      "heading" : null,
      "text" : "ar X\niv :1\n70 2.\n07 12\n1v 1\n[ st\nat .M\nL ]\n2 3\nFe b\n20 17\n(OPE) has been actively studied in the last decade due to its importance both as a stand-alone problem and as a module in a policy improvement scheme. However, most Temporal Difference (TD) based solutions ignore the discrepancy between the stationary distribution of the behavior and target policies and its effect on the convergence limit when function approximation is applied. In this paper we propose the Consistent Off-Policy Temporal Difference (COP-TD(λ, β)) algorithm that addresses this issue and reduces this bias at some computational expense. We show that COP-TD(λ, β) can be designed to converge to the same value that would have been obtained by using on-policy TD(λ) with the target policy. Subsequently, the proposed scheme leads to a related and promising heuristic we call logCOP-TD(λ, β). Both algorithms have favorable empirical results to the current state of the art online OPE algorithms. Finally, our formulation sheds some new light on the recently proposed Emphatic TD learning."
    }, {
      "heading" : "1. Introduction",
      "text" : "Reinforcement Learning (RL) techniques were successfully applied in fields such as robotics, games, marketing and more (Kober et al., 2013; Al-Rawi et al., 2015; Barrett et al., 2013). We consider the problem of offpolicy evaluation (OPE) – assessing the performance of a complex strategy without applying it. An OPE formulation is often considered in domains with limited sampling capability. For example, marketing and recommender systems (Theocharous & Hallak, 2013; Theocharous et al., 2015) directly relate policies to revenue. A more extreme example is drug administration, as there are only few patients in the testing population, and sub-optimal policies\n1The Technion, Haifa, Israel. Correspondence to: Assaf Hallak <ifogph@gmail.com>, Shie Mannor <shie@ee.technion.ac.il>.\ncan have life threatening effects (Hochberg et al., 2016). OPE can also be useful as a module for policy optimization in a policy improvement scheme (Thomas et al., 2015a).\nIn this paper, we consider the OPE problem in an on-line setup where each new sample is immediately used to update our current value estimate of some previously unseen policy. We propose and analyze a new algorithm called COP-TD(λ,β) for estimating the value of the target policy; COP-TD(λ,β) has the following properties:\n1. Easy to understand and implement on-line.\n2. Allows closing the gap to consistency such that the\nlimit point is the same that would have been obtained by on-policy learning with the target policy.\n3. Empirically comparable to state-of-the art algorithms.\nOur algorithm resembles (Sutton et al., 2015)’s Emphatic TD that was extended by (Hallak et al., 2015) to the general parametric form ETD(λ,β). We clarify the connection between the algorithms and compare them empirically. Finally, we introduce an additional related heuristic called Log-COP-TD(λ,β) and motivate it."
    }, {
      "heading" : "2. Notations and Background",
      "text" : "We consider the standard discounted Markov Decision Process (MDP) formulation (Bertsekas & Tsitsiklis, 1996) with a single long trajectory. Let M = (S,A,P ,R, ζ, γ) be an MDP where S is the finite state space and A is the finite action space. The parameter P sets the transition probabilities Pr(s′|s, a) given the previous state s ∈ S and action a ∈ A, where the first state is determined by the distribution ζ. The parameter R sets the reward distribution r(s, a) obtained by taking action a in state s and γ is the discount factor specifying the exponential reduction in reward with time.\nThe process advances as follows: A state s0 is sampled according to the distribution ζ(s). Then, at each time step t starting from t = 0 the agent draws an action at according to the stochastic behavior policy µ(a|st), a reward rt . = r(st, at) is accumulated by the agent, and the next state st+1 is sampled using the transition probability Pr(s′|st, at).\nThe expected discounted accumulated reward starting from a specific state and choosing an action by some policy π is called the value function, which is also known to satisfy the Bellman equation in a vector form:\nV π(s) = Eπ\n[ ∞∑\nt=0\nγtrt ∣∣∣ s0 = s ] , TπV . = Rπ + γPπV,\nwhere [Rπ]s . = Eπ [r(s, π(s))] and [Pπ]s,s′ . = Eπ [Pr(s ′|s, π(s))] are the policy induced reward vector and transition probability matrix respectively; Tπ is called the Bellman operator. The problem of estimating V π(s) from samples is called policy evaluation. If the target policy π is different than the behavior policy µ which generated the samples, the problem is called off-policy evaluation (OPE). The TD(λ) (Sutton, 1988) algorithm is a standard solution to on-line on-policy evaluation: Each time step the temporal difference error updates the current value function estimate, such that eventually the stochastic approximation process will converge to the true value function. The standard form of TD(λ) is given by:\nR (n) t,st =\nn−1∑\ni=0\nγirt+i + γ nV̂t(st+n),\nRλt,st =(1− λ) ∞∑\nn=0\nλnR(n+1)st ,\nV̂t+1(st) =V̂t(st) + αt ( Rλt,st − V̂t(st) ) ,\n(1)\nwhere αt is the step size. The value R (n) t,st is an estimate of the current state’s V (st), looking forward n steps, and Rλt,st is an exponentially weighted average of all of these estimates going forward till infinity. Notice that Equation 1 does not specify an on-line implementation since R (n) t,st depends on future observations, however there exists a compact on-line implementation using eligibility traces (Bertsekas & Tsitsiklis (1996) for on-line TD(λ), and Sutton et al. (2014), Sutton et al. (2015) for off-policy TD(λ)). The underlying operator of TD(λ) is given by:\nT λπ V = (1 − λ)\n∞∑\nn=0\nλn\n( n∑\ni=0\nγiP iπRπ + γ n+1Pn+1π V\n)\n= (1 − λ)(I − λTπ) −1TπV,\nand is a γ(1−λ) 1−λγ -contraction (Bertsekas, 2012).\nWe denote by dµ(s) the stationary distribution over states induced by taking the policy µ and mark Dµ = diag(dµ). Since we are concerned with the behavior at infinite horizon, we assume ζ(s) = dµ(s). In addition, we assume that the MDP is ergodic for the two specified policies µ, π so ∀s ∈ S : dµ(s) > 0, dπ(s) > 0 and that the OPE problem is proper – π(a|s) > 0 ⇒ µ(a|s) > 0.\nWhen the state space is too large to hold V π(s), a linear function approximation scheme is used: V π(s) ≈ θ⊤π φ(s), where θ is the optimized weight vector and φ(s) is the feature vector of state s composed of k features. We denote by Φ ∈ RS,k the matrix whose lines consist of the feature vectors for each state and assume its columns are linearly independent.\nTD(λ) can be adjusted to find the fixed point of ΠdπT λ π where Πdπ is the projection to the subspace spanned by the features with respect to the dπ-weighted norm (Sutton & Barto, 1998):\nR (n) t,st =\nn−1∑\ni=0\nγirt+i + γ nθ⊤t φ(st+n),\nRλt,st =(1− λ)\n∞∑\nn=0\nλnR(n+1)st ,\nθt+1 =θt + αt ( Rλt,st − θ ⊤ t φ(st) ) φ(st).\nFinally, we define OPE-related quantities:\nρt . = π(at|st)\nµ(at|st) , Γnt\n. =\nn−1∏\ni=0\nρt−1−i, ρd(s) . = dπ(s)\ndµ(s) ,\n(2)\nwe call ρd the covariate shift ratio (as denoted under different settings by (Hachiya et al., 2012)).\nWe summarize the assumptions used in the proofs:\n1. Under both policies the induced Markov chain is er-\ngodic.\n2. The first state s0 is distributed according to the stationary distribution of the behavior policy dµ(s).\n3. The problem is proper: π(a|s) > 0 ⇒ µ(a|s) > 0.\n4. The feature matrix Φ has full rank k.\nAssumption 1 is commonly used for convergence theorems as it verifies the value function is well defined on all states regardless of the initial sampled state. Assumption 2 can be relaxed since we are concerned with the long-term properties of the algorithm past its mixing time – we require it for clarity of the proofs. Assumption 3 is required so the importance sampling ratios will be well defined. Assumption 4 guarantees the optimal θ is unique which greatly simplifies the proofs."
    }, {
      "heading" : "3. Previous Work",
      "text" : "We can roughly categorize previous OPE algorithms to two main families. Gradient based methods that perform\nstochastic gradient descent on error terms they want to minimize. These include GTD (Sutton et al., 2009a), GTD2, TDC (Sutton et al., 2009b) and HTD (White & White, 2016). The main disadvantages of gradient based methods are (A) they usually update an additional error correcting term, which means another time-step parameter needs to be controlled; and (B) they rely on estimating non-trivial terms, an estimate that tends to converge slowly. The other family uses importance sampling (IS) methods that correct the gains between on-policy and off-policy updates using the IS-ratios ρt’s. Among these are full IS (Precup et al., 2001) and ETD(λ,β) (Sutton et al., 2015). These methods are characterized by the bias-variance trade-off they resort to – navigating between biased convergent values (or even divergent), and very slow convergence stemming from the high variance of IS correcting factors (the ρt products). There are also a few algorithms that fall between the two, for example TO-GTD (van Hasselt et al., 2014) and WISTD(λ) (Mahmood & Sutton, 2015).\nA comparison of these algorithms in terms of convergence rate, synergy with function approximation and more is available in (White & White, 2016; Geist & Scherrer, 2014). We focus in this paper on the limit point of the convergence. For most of the aforementioned algorithms, the process was shown to converge almost surely to the fixed point of the projected Bellman operator ΠdTπ where d is some stationary distribution (usually dµ), however the d in question was never1 dπ as we would have obtained from running on-policy TD with the target policy. The algorithm achieving the closest result is ETD(λ,β) which replaced d with f = ( I − βP⊤π )−1 dµ, where β trades-off some of the process’ variance with the bias in the limit point. Hence, our main contribution is a consistent algorithm which can converge to the same value that would have been obtained by running an on-policy scheme with the same policy."
    }, {
      "heading" : "4. Motivation",
      "text" : "Here we provide a motivating example showing that even in simple cases with “close” behavior and target policies, the two induced stationary distributions can differ greatly. Choosing a specific linear parameterization further emphasizes the difference between applying on-policy TD with the target policy, and applying inconsistent off-policy TD.\nAssume a chain MDP with numbered states 1, 2, ..|S|, where from each state s you can either move left to state s − 1, or right to state s + 1. If you’ve reached the beginning or the end of the chain (states 1 or |S|) then taking a step further does not affect your location. Assume the behavior policy moves left with probability 0.5+ ǫ, while the\n1Except full IS, however its variance is too high to be applicable in practice.\ntarget policy moves right with probability 0.5+ ǫ. It is easy to see that the stationary distributions are given by:\ndµ(s) ∝\n( 0.5− ǫ\n0.5 + ǫ\n)s , dπ(s) ∝ ( 0.5 + ǫ\n0.5− ǫ\n)s .\nFor instance, if we have a length 100 chain with ǫ = 0.01, for the rightmost state we have dµ(|S|) ≈ 8 · 10−4, dπ(|S|) ≈ 0.04. Let’s set the reward to be 1 for the right half of the chain, so the target policy is better since it spends more time in the right half. The value of the target policy in the edges of the chain for γ = 0.99 is V π(1) = 0.21, V π(100) = 99.97.\nNow what happens if we try to approximate the value function using one constant feature φ(s) ≡ 1? The fixed point of ΠdµTπ is θ = 11.92, while the fixed point of ΠdπTπ is θ = 88.08 – a substantial difference. The reason for this difference lies in the emphasis each projection puts on the states: according to Πdµ , the important states are in the left half of the chain – these with low value function, and therefore the value estimation of all states is low. However, according to Πdπ the important states are concentrated on the right part of the chain since the target policy will visit these more often. Hence, the estimation error is emphasized on the right part of the chain and the value estimation is higher. When we wish to estimate the value of the target policy, we want to know what will happen if we deploy it instead of the behavior policy, thus taking the fixed point of ΠdπTπ better represents the off-policy evaluation solution.\n5. COP-TD(λ, β)\nMost off-policy algorithms multiply the TD summand of TD(λ) with some value that depends on the history and the current state. For example, full IS-TD by (Precup et al., 2001) examines the ratio between the probabilities of the trajectory under both policies:\nPπ(s0, a0, s1, . . . , st, at) Pµ(s0, a0, s1, . . . , st, at) =\nt∏\nm=0\nρm = Γ t tρt. (3)\nIn problems with a long horizon, or these that start from the stationary distribution, we suggest using the time-invariant covariate shift ρd multiplied by the current ρt. The intuition is the following: We would prefer using the probabilities ratio given in Equation 3, but it has very high variance, and after many time steps we might as well look at the stationary distribution ratio instead. This direction leads us to the following update equations:\nθt+1 =\nθt + αtρd(st)ρt ( rt + θ ⊤ t (γφ(st+1)− φ(st)) ) φ(st).\n(4)\nLemma 1. If the αt satisfy ∑∞ t=0 αt = ∞, ∑∞ t=0 α 2 t < ∞ then the process described by Eq. (4) converges almost surely to the fixed point of ΠπTπV = V .\nThe proof follows the ODEmethod (Kushner & Yin, 2003) similarly to Tsitsiklis & Van Roy (1997) (see the appendix for more details).\nSince ρd(s) is generally unknown, it is estimated using an additional stochastic approximation process. In order to do so, we note the following Lemma:\nLemma 2. Let ρ̂d be an unbiased estimate of ρd, and for every n = 0, 1, . . . , t define Γ̃nt . = ρ̂d(st−n)Γ n t . Then:\nEµ [ Γ̃nt |st ] = ρd(st).\nFor any state st there are t → ∞ such quantities {Γ̃ n t } t n=0, where we propose to weight them similarly to TD(λ):\nΓ̃βt = (1 − β) ∞∑\nn=0\nβnΓ̃n+1t . (5)\nNote that ρd(s), unlike V (s), is restricted to a close set since its dµ-weighted linear combination is equal to 1 and all of its entries are non-negative; We denote this dµweighted simplex by∆dµ , and letΠ∆dµ be the (non-linear) projection to this set with respect to the Euclidean norm (Π∆dµ can be calculated efficiently, (Chen & Ye, 2011)). Now, we can devise a TD algorithmwhich estimates ρd and uses it to find θ, which we call COP-TD(0, β) (Consistent Off-Policy TD).\nAlgorithm 1 COP-TD(0,β), Input: θ0, ρ̂d,0,\n1: Init: F0 = 0, n β 0 = 1, N(s) = 0 2: for t = 1, 2, ... do 3: Observe st, at, rt, st+1 4: Update normalization terms: 5: N(st) = N(st) + 1, ∀s ∈ S : d̂µ(s) = N(s) t 6: nβt = βn β t + 1 7: Update Γnt ’s weighted average: 8: Ft = ρt−1(βFt−1 + est−1) 9: Update & project by ρd’s TD error:\n10: δdt = F⊤t ρ̂d,t\nnβt︸ ︷︷ ︸ →Γ̃βt\n−ρ̂d,t(st)\n11: ρ̂d,t+1 = Π∆d̂µ\n( ρ̂d,t + α d t δ d t est )\n12: Off-policy TD(0): 13: δt = rt + θ ⊤ t (γφ(st+1)− φ(st)) 14: θt+1 = θt + αtρ̂d,t+1(st)ρtδtφ(st) 15: end for\nSimilarly to the Bellman operator for TD-learning, we de-\nfine the underlying COP-operator Y and its β extension:\nY u = D−1µ P ⊤ π Dµu,\nY βu = (1− β)D−1µ P ⊤ π (I − βP ⊤ π ) −1Dµu. (6)\nThe following Lemma may give some intuition on the convergence of the ρd estimation process:\nLemma 3. Under the ergodicity assumption, denote the eigenvalues of Pπ by 0 ≤ · · · ≤ |ξ2| < ξ1 = 1. Then Y β is amaxi6=1 (1−β)|ξi| |1−βξi| < 1-contraction in the L2-norm on the orthogonal subspace to ρd, and ρd is a fixed point of Y β .\nThe technical proof is given in the appendix. Theorem 1. If the step sizes satisfy ∑ t αt = ∑ t α d t =\n∞, ∑\nt(α 2 t + (α d t ) 2) < ∞, αt αdt → 0, tαdt → 0, and\nE [ (βnΓnt ) 2|st ]\n≤ C for some constant C and every t and n, then after applying COP-TD(0, β), ρ̂d,t converges to ρd almost surely, and θt converges to the fixed point of ΠπTπV .\nNotice that COP-TD(0, β) given in Alg. 1 is infeasible in problems with large state spaces since ρd ∈ R |S|. Like TD(λ), we can introduce linear function approximation: represent ρd(s) ≈ θ ⊤ ρ φρ(s) where θρ is a weight vector and φρ(s) is the off-policy feature vector and adjust the algorithm accordingly. For ρ̂d to still be contained in the set ∆dµ , we pose the requirement on the feature vectors: φρ(s) ∈ R k +, and ∑ s dµ(s)θ ⊤ ρ φρ(s) = 1 ( noted as\nthe simplex projection Π∆Eµ[φρ(s)] ) . In practice, the latter\nrequirement can be approximated: ∑\ns dµ(s)θ ⊤ ρ φρ(s) ≈\n1 t θ⊤ρ ∑\nt φρ(st) = 1 resulting in an extension of the previously applied dµ estimation (step 5 in COP-TD(0, β)). We provide the full details in Algorithm 2, which also incorporates non-zero λ ( similarly to ETD(λ,β) ) . Theorem 2. If the step sizes satisfy ∑ t αt = ∑ t α d t =\n∞, ∑\nt(α 2 t + (α d t ) 2) < ∞, αt αdt → 0, tαdt → 0, and\nE [ (βnΓnt ) 2|st ] ≤ C for some constant C and every t, n, then after applying COP-TD(0, β) with function approximation satisfying φρ(s) ∈ R k +, ρ̂d,t converges to the fixed point of Π∆Eµ[φρ]ΠφρY β denoted by ρCOPd almost surely, and if θt converges it is to the fixed point of Πdµ◦ρCOPd TπV , where ◦ is a coordinate-wise product of vectors.\nThe proof is given in the appendix and also follows the ODE method. Notice that a theorem is only given for λ = 0, convergence results for general λ should follow the work by Yu (2015).\nA possible criticism on COP-TD(0,β) is that it is not actually consistent, since in order to be consistent the original state space has to be small, in which case every off-policy algorithm is consistent as well. Still, the dependence on another set of features allows to trade-off accuracy with\nAlgorithm 2 COP-TD(λ,β) with Function Approximation, Input: θ0, θρ,0\n1: Init: F0 = 0, n β 0 = 1, Nφ = 0, e0 = 0 2: for t = 1, 2, ... do 3: Observe st, at, rt, st+1 4: Update normalization terms: 5: nβt = βn β t + 1, Nφ = Nφ + φρ(st), d̂φρ = Nφ t 6: Update Γnt ’s weighted average: 7: Ft = ρt−1(βFt−1 + φρ(st−1)) 8: Update & project by ρd’s TD error: 9: δdt = θ ⊤ ρ,t−1 ( Ft\nn β t\n− φρ(st) )\n10: θρ,t+1 = Π∆ d̂φρ\n( θρ,t + α d t δ d t φρ(st) )\n11: Off-policy TD(λ): 12: Mt = λ+ (1− λ)θ ⊤ ρ,t+1φρ(st) 13: et = ρt (λγet +Mtφ(st+1)) 14: δt = rt + θ ⊤ t (γφ(st+1)− φ(st)) 15: θt+1 = θt + αtδtet 16: end for\ncomputational power in estimating ρd and subsequently V . Moreover, smart feature selection may further reduce this gap, and COP-TD(0, β) is still the first algorithm addressing this issue. We conclude with linking the error in ρd’s estimate with the difference in the resulting θ, which suggests that a well estimated ρd results in consistency: Corollary 1. Let 0 < ǫ < 1. If (1 − ǫ)ρd ≤ ρ COP d ≤ (1 + ǫ)ρd, then the fixed point of COP-TD(0,β) with function approximation θCOP satisfies the following, where ‖ · ‖∞ is the L∞ induced norm:\n‖θ∗ − θCOP‖∞ ≤\nǫ‖A−1π Φ ⊤‖∞ ( Rmax + (1 + γ)‖Φ‖∞‖θ COP‖∞ ) ,\n(7)\nwhereAπ = Φ ⊤Dπ(I−γPπ)Φ, and θ ∗ sets the fixed point of the operator ΠdπTπV ."
    }, {
      "heading" : "5.1. Relation to ETD(λ, β)",
      "text" : "Recently, Sutton et al. (2015) had suggested an algorithm for off-policy evaluation called Emphatic TD. Their algorithm was later on extended by Hallak et al. (2015) and renamed ETD(λ, β), which was shown to perform extremely well empirically by White & White (2016). ETD(0, β) can be represented as:\nFt = (1− β)\n∞∑\nn=0\nβnΓnt ,\nV̂t+1(st) = V̂t(st) + αtFtρt ( rt + θ ⊤ t (γφ(st+1)− φ(st)) ) .\n(8)\nAs mentioned before, ETD(λ, β) converges to the fixed\npoint of ΠfT λ π (Yu, 2015), where f = E [Ft|st] = (I − βPπ) −1dµ. Error bounds can be achieved by showing that the operator ΠfT λ π is a contraction under certain requirements on β and that the variance of Ft is directly related to β as well (Hallak et al., 2015) (and thus affects the convergence rate of the process).\nWhen comparing ETD(λ,β)’s form to COP-TD(λ,β)’s, instead of spending memory and time resources on a state/feature-dependent Ft, ETD(λ,β) uses a one-variable approximation. The resulting Ft is in fact a one-step estimate of ρd, starting from ρ̂d(s) ≡ 1 (see Equations 15, 8), up to a minor difference: F ETDt = βF COP-TD t + 1 (which following our logic adds bias to the estimate 2).\nUnlike ETD(λ, β), COP-TD(λ,β)’s effectiveness depends on the available resources. The number of features φρ(s) can be adjusted accordingly to provide the most affordable approximation. The added cost is fine-tuning another stepsize, though β’s effect is less prominent."
    }, {
      "heading" : "6. The Logarithm Approach for Handling Long Products",
      "text" : "We now present a heuristic algorithm which works similarly to COP-TD(λ, β). Before presenting the algorithm, we explain the motivation behind it."
    }, {
      "heading" : "6.1. Statistical Interpretation of TD(λ)",
      "text" : "Konidaris et al. (2011) suggested a statistical interpretation of TD(λ). They show that under several assumptions the TD(λ) estimate Rλst is the maximum likelihood estimator of V (st) given R n st : (1) Each Rnst is an unbiased estimator of V (st); (2) The random variables R n st are independent and specifically uncorrelated; (3) The random variablesRnst are jointly normally distributed; and (4) The variance of each Rnst is proportional to λ n.\nUnder Assumptions 1-3 the maximum likelihood estimator of V (s) given its previous estimate can be represented as a linear convex combination of Rnst with weights:\nwn =\n[ Var ( R (n) st )]−1\n∑∞ m=0 [ Var ( R (m) st )]−1 . (9)\nSubsequently, in Konidaris et al. (2011) Assumption 4 was relaxed and instead a closed form approximation of the variance was proposed. In a follow-up paper by Thomas et al. (2015b), the second assumption was also removed and the weights were instead given as: wn =\n2We have conducted several experiments with an altered ETD and indeed obtained better results compared with the original, these experiments are outside the scope of the paper.\n1⊤cov(Rst)en 1⊤cov(Rst)1 , where the covariancematrix can be estimated from the data, or otherwise learned through some parametric form.\nWhile both the approximated variance and learned covariance matrix solutions improve performance on several benchmarks, the first uses a rather crude approximation, and the second solution is both state-dependent and based on noisy estimates of the covariance matrix. In addition, there aren’t efficient on-line implementations since all past weights should be recalculated to match a new sample. Still, the suggested statistical justification is a valuable tool in assessing the similar role of β in ETD(λ, β)."
    }, {
      "heading" : "6.2. Variance Weighted Γnt",
      "text" : "As was shown by Konidaris et al. (2011), we can use statedependent weights instead of β exponents to obtain better estimates. The second moments are given explicitly as follows3: E [ (Γnt ) 2 |st ] = d⊤µ P̃ n−1est\ndµ(st) , where [ P̃ ] s,s′ =\n∑ a∈A π2(a|s) µ(a|s) P (s ′|s, a).\nThese can be estimated for each state separately. Notice that the variances increase exponentially depending on the largest eigenvalue of P̃ (as Assumption 4 dictates), but this is merely an asymptotic behavior and may be relevant only when the weights are already negligible. Hence, implementing this solution on-line should not be a problem with the varying weights, as generally only the first few of these are non-zero. While this solution is impractical in problems with large state spaces parameterizing or approximating these variances (similarly to Thomas et al. (2015b)) could improve performance in specific applications."
    }, {
      "heading" : "6.3. Log-COP-TD(λ, β)",
      "text" : "Assumption 3 in the previous section is that the sampled estimators (R(n),Γnt ) are normally distributed. For on policy TD(λ), this assumption might seem not too harsh as the estimators R(n) represent growing sums of random variables. However, in our case the estimators Γnt are growing products of random variables. To correct this issue we can define new estimators using a logarithm on each Γ̃nt :\nlog [ρd(st)] = log\n[ E [ ρ̂d(st−m) t−1∏\nk=t−m\nρk ∣∣ st ]]\n≈ log [ρ̂d(st−m)] + t−1∑\nk=t−m\nE [log [ρk] |st] .\n(10)\n3The covariances can be expressed analytically as well, for clarity we drop this immediate result.\nThis approximation is crude – we could add terms reducing the error through Taylor expansion, but these would be complicated to deal with. Hence, we can relate to this method mainly as a well-motivated heuristic.\nNotice that this formulation resembles the standard MDP formulation, only with the corresponding ”reward” terms log[ρt] going backward instead of forward, and no discount factor. Unfortunately, without a discount factor we cannot expect the estimated value to converge, so we propose using an artificial one γlog. We can incorporate function approximation for this formulation as well. Unlike COP-TD(λ, β), we can choose the features and weights as we wish with no restriction, besides the linear constraint on the resulting ρd through the weight vector θρ. This can be approximately enforced by normalizing θρ using X t . = 1 t ∑ t exp(θ ⊤ ρ,tφ(st)) (which should equal 1 if we were exactly correct). We call the resulting algorithm LogCOP-TD(λ,β).\nAlgorithm 3 Log-COP-TD(λ,β) with Function Approximation, Input: θ0,θρ,0\n1: Init: F0 = 0, n0(β) = 1, N(s) = 0 2: for t = 1, 2, ... do 3: Observe st, at, rt, st+1 4: Update normalization terms: 5: nβt = βn β t + 1, Nφ = γlog(βNφ +\nφρ(st)), X = X + exp(θ ⊤ ρ,tφ(st))\n6: Update log(Γnt )’s weighted average: 7: Ft = βγlogFt−1 + n β t log[ρ(st−1)] 8: Update & project by log(ρd)’s TD error: 9: δdt = Ft\nn β t\n+ θ⊤ρ,t\n( Nφ\nn β t\n− φρ(st) )\n10: θρ,t+1 = θρ,t + α d t δ d t φρ(st) 11: Off-policy TD(λ): 12: Mt = λ+ (1− λ) exp ( θ⊤ρ,t+1φρ(st) ) /(X/t) 13: et = ρt (λγet +Mtφ(st+1)) 14: δt = rt + θ ⊤ t (γφ(st+1)− φ(st)) 15: θt+1 = θt + αtδtet 16: end for"
    }, {
      "heading" : "6.4. Using the Original Features",
      "text" : "An interesting phenomenon occurs when the behavior and target policies employ a feature based Boltzmann distribution for choosing the actions: µ(a|s) = exp ( θ⊤a,µφ(s) ) ,\nand π(a|s) = exp ( θ⊤a,πφ(s) ) , where a constant feature is added to remove the (possibly different) normalizing constant. Thus, log(ρt) = (θa,π − θa,µ) ⊤φ(st), and LogCOP-TD(λ,β) obtains a parametric form that depends on the original features instead of a different set."
    }, {
      "heading" : "6.5. Approximation Hardness",
      "text" : "As we propose to use linear function approximation for ρd(s) and log (ρd(s)) one cannot help but wonder how hard it is to approximate these quantities, especially compared to the value function. The comparison between V (s) and ρd(s) is problematic for several reasons:\n1. The ultimate goal is estimating V π(s), approximation errors in ρd(s) are second order terms.\n2. The value function V π(s) depends on the policyinduced reward function and transition probability\nmatrix, while ρd(s) depends on the stationary distributions induced by both policies. Since each depends on at least one distinct factor - we can expect different setups to result in varied approximation hardness. For example, if the reward function has a poor approximation then so will V π(s), while extremely different behavior and target policies can cause ρd(s) to behave erratically.\n3. Subsequently, the choice of features for approximat-\ning V π(s) and ρd(s) can differ significantly depending on the problem at hand.\nIf we would still like to compare V π(s) and ρd(s), we could think of extreme examples:\n• When π = µ, ρd(s) ≡ 1, when R(s) ≡ 0 then V π(s) ≡ 0.\n• In the chain MDP example in Section 4 we saw that ρd(s) is an exponential function of the location in the chain. Setting reward in one end to 1 will result in an exponential form for V π(s) as well. Subsequently, in the chain MDP example approximating log (ρd(s)) is easier than ρd(s) as we obtain a linear function of the position; This is not the general case."
    }, {
      "heading" : "7. Experiments",
      "text" : "We have performed 3 types of experiments. Our first batch of experiments (Figure 1) demonstrates the accuracy of predicting ρd by both COP-TD(λ, β) and Log-COP-TD(λ, β). We show two types of setups in which visualization of ρd is relatively clear - the chain MDP example mentioned in Section 4 and the mountain car domain (Sutton & Barto, 1998) in which the state is determined by only two continuous variables - the car’s position and speed. The parameters λ and β exhibited low sensitivity in these tasks so they were simply set to 0, we show the estimated ρd after 106 iterations. For the chain MDP (top two plots, notice the logarithmic scale) we first approximate ρd without any function approximation (top-left) and we can see COP-TD\nmanages to converge to the correct value while Log-COPTD is much less exact. When we use linear feature space (constant parameter and position) Log-COP-TD captures the true behavior of ρd much better as expected. The two lower plots show the error (in color) in ρd estimated for the mountain car with a pure exploration behavior policy vs. a target policy oriented at moving right. The z-axis is the same for both plots and it describes a much more accurate estimate of ρd obtained through simulations. The features used were local state aggregation. We can see that both algorithms succeed similarly on the position-speed pairs which are sampled often due to the behavior policy and the mountain. When looking at more rarely observed states, the estimate becomes worse for both algorithms, though Log-COP-TD seems to be better performing on the spike at position > 0.\nNext we test the sensitivity of COP-TD(λ, β) and LogCOP-TD(λ,β) to the parameters β and γlog (Figure 2) on two distinct toy examples - the chain MDP introduced before but with only 30 states with the position-linear features, and a random MDP with 32 states, 2 actions and a 5-bit binary feature vector along with a free parameter (this compact representation was suggested by White & White (2016) to approximate real world problems). The policies on the chain MDP were taken as described before, and on the random MDP a state independent 0.75/0.25 probability to choose an action by the behavior/target policy. As we can see, larger values of β cause noisier estimations in the randomMDP for COP-TD(λ, β), but has little effect in other venues. As for γlog - we can see that if it is too large or too small the error behaves sub-optimally, as expected for the crude approximation of Equation 10. In conclusion, unlike ETD(λ, β), Log/COP-TD(λ, β) are much less effected by β, though γlog should be tuned to improve results.\nOur final experiment (Figure 3) compares our algorithms to ETD(λ, β) and GTD(λ, β) over 4 setups: chain MDP with 100 states with right half rewards 1 with linear features, a 2 action random MDP with 256 states and binary features, acrobot (3 actions) and cart-pole balancing (21 actions) (Sutton & Barto, 1998) with reset at success and state aggregation to 100 states. In all problems we used the same features for ρd and V\nπ(s) estimation, γ = 0.99, constant step size 0.05 for the TD process and results were averaged over 10 trajectories, other parameters (λ, β, other step sizes, γlog) were swiped over to find the best ones. To reduce figure clutter we have not included standard deviations though the noisy averages still reflect the variance in the process. Our method of comparison on the first 2 setups estimates the value function using the suggested algorithm, and finds the dπ weighted average of the error between V and the on-policy fixed point ΠπTVπ:\n‖V̂ −ΠπTVπ‖ 2 dπ\n= ∑\ns\ndπ(s) [ (θ∗ − θ̂)⊤φ(s) ]2 , (11)\nwhere θ∗ is the optimal θ obtained by on-policy TD using the target policy. On the latter continuous state problems we applied on-line TD on a different trajectory following the target policy, used the resulting θ value as ground truth and taken the sum of squared errors with respect to it. The behavior and target policies for the chain MDP and random MDP are as specified before. For the acrobot problem the behavior policy is uniform over the 3 actions and the target policy chooses between these with probabilities (16 , 1 3 , 1 2 ). For the cart-pole the action space is divided to 21 actions from -1 to 1 equally, the behavior policy chooses among these uniformly while the target policy is 1.5 times more\nprone to choosing a positive action than a negative one.\nThe experiments show that COP-TD(λ, β) and Log-COPTD(λ, β) have comparable performance to ETD(λ, β) where at least one is better in every setup. The advantage in the new algorithms is especially seen in the chain MDP corresponding to a large discrepancy between the stationary distribution of the behavior and target policy. GTD(λ) is consistently worse on the tested setups, this might be due to the large difference between the chosen behavior and target policies which affects GTD(λ) the most."
    }, {
      "heading" : "8. Conclusion",
      "text" : "Research on off-policy evaluation has flourished in the last decade. While a plethora of algorithms were suggested so far, ETD(λ, β) by Hallak et al. (2015) has perhaps the simplest formulation and theoretical properties. Unfortunately, ETD(λ, β) does not converge to the same point achieved by on-line TD when linear function approximation is applied.\nWe address this issue with COP-TD(λ,β) and proved it can achieve consistency when used with a correct set of features, or at least allow trading-off some of the bias by adding or removing features. Despite requiring a new set of features and calibrating an additional update function, COP-TD(λ,β)’s performance does not depend as much on β as ETD(λ,β), and shows promising empirical results.\nWe offer a connection to the statistical interpretation of TD(λ) that motivates our entire formulation. This interpretation leads to two additional approaches: (a) weight the Γnt using estimated variances instead of β exponents and (b) approximating log[ρd] instead of ρd; both approaches deserve consideration when facing a real application."
    }, {
      "heading" : "9.1. Proof of Lemma 1",
      "text" : "If the step sizes αt hold ∑∞ t=0 αt = ∞, ∑∞ t=0 α 2 t < ∞ then the process described by Equation 4 converges almost surely to the fixed point of ΠπTπV = V .\nProof. Similarly to on-policy TD, we define A and b, the fixed point is the solution to Aθ = b. First we find A and show\nstability:\nA = lim t→∞ Eµ\n[ ρtρd(st)φt(φt − γφt+1) ⊤ ]\n= ∑\ns\ndµ(s)ρd(s)Eµ [ ρkφk(φk − γφk+1) ⊤|sk = s ]\n= ∑\ns\ndπ(s)Eπ [ ρkφk(φk − γφk+1) ⊤|sk = s ]\n= Φ⊤Dπ(I − γPπ)Φ.\n(12)\nThis is exactly the same A we would have obtained from TD(0) and it is negative definite (see (Sutton et al., 2015)). Similarly we can find b:\nb = lim t→∞ Eµ\n[ ρtρd(st)φtr ⊤ t |sk = s ]\n= ∑\ns\ndµ(s)ρd(s)Eµ [ρkφkrk|sk = s]\n= ∑\ns\ndπ(s)Eπ [φkrk|sk = s]\n= Φ⊤DπRπ,\n(13)\nand we obtained the same b as on-policy TD(0) with π.\nNow we consider the noise of this off-policy TD, which is exactly the same noise as the on-policy TD only multiplied by ρtρd(st) - as long as the noise term of the ODE formulation (Kushner & Yin, 2003) is still bounded, the proof is exactly the same. According to Assumption 1, we know that ρd is lower and upper bounded. By Assumption 3 we also know that ρt is lower and upper bounded. Therefore the noise of the new process is bounded and the same a.s. convergence applies as on-policy TD(0) (Tsitsiklis & Van Roy, 1997). Since A, b are the same as on-policy TD(0) for the target policy π, the convergence is to the same fixed point."
    }, {
      "heading" : "9.2. Proof of Lemma 2",
      "text" : "Let ρ̂d be an unbiased estimate of ρd, and for every n = 0, 1, . . . , t define Γ̃ n t . = ρ̂d(st−n)Γ n t . Then:\nEµ [ Γ̃nt |st ] = ρd(st).\nProof. For any function on the state space u(s):\nEµ [Γ n t u(st−n)|st] =\n∑\n(si) t−1 i=t−n\nPr µ ((si)\nt−1 i=t−n |st)Γ n t u(st−n)\n= ∑\n(si) t−1 i=t−n\nPrµ((si) t−1 i=t−n , st)\nPrµ(st) Γnt u(st−n)\n= ∑\n(si) t−1 i=t−n\nPrµ(st−n) Prπ((si) t−1 i=t−n , st|st−n)\nPrµ(st) u(st−n)\n= ∑\nst−n\nPrµ(st−n) Prπ(st|st−n)\nPrµ(st) u(st−n)\n=u⊤DµP n π D −1 µ est ,\n(14)\nwhere est is the unit vector of state st. So, for an unbiased estimate of ρd denoted ρ̂d we can define and derive:\nΓ̃nt . =ρ̂d(st−n)Γ n t = ρ̂d(st−n)\nn−1∏\ni=0\nρt−i−1,\n⇒ Eµ [ Γ̃nt |st ] = E [ρ̂d] ⊤ DµP n π D −1 µ est\n= ρ⊤d DµP n π D −1 µ est = d⊤π P n π D −1 µ est = d⊤πD −1 µ est = ρd(st).\n(15)"
    }, {
      "heading" : "9.3. Proof of Lemma 3",
      "text" : "Under the ergodicity assumption, denote the eigenvalues of Pπ by 0 ≤ · · · ≤ |ξ2| < ξ1 = 1. Then Y β is a maxi6=1 (1−β)|ξi| |1−βξi| -contraction in the L2-norm on the orthogonal subspace to ρd, and ρd is a fixed point of Y β .\nProof. We first show that ρd is a fixed point of Y β :\nY βρd = (1− β)D −1 µ P ⊤ π (I − βP ⊤ π ) −1Dµ ( D−1µ dπ )\n= (1− β)D−1µ P ⊤ π (I − βP ⊤ π ) −1dπ = (1− β)D−1µ (1− β) −1dπ = D−1µ dπ = ρd\n(16)\nDue to similarity, the eigenvalues of Y β are the same as these of (1−β)P⊤π (I−βP ⊤ π ) −1 which is a stochastic matrix with eigenvalues (\n(1−β)ξi 1−βξi )|S| i=1 , where for i = 1 we obtain the eigenvalue 1. Now for every vector orthogonal to ρd denoted u,\nthe first eigenvalue has no effect on its spectral decomposition, which means that ‖Y βu‖ ≤ maxi6=1 (1−β)|ξi| |1−βξi| ‖u‖."
    }, {
      "heading" : "9.4. Proof of Theorem 1",
      "text" : "If the step sizes satisfy ∑ t αt = ∑ t α d t = ∞, ∑ t(α 2 t + (α d t )\n2) < ∞, αt αdt\n→ 0, tαdt → 0, and E [ (βnΓnt ) 2|st ] ≤ C for\nsome constant C and every t, n, then after applying COP-TD(0, β), ρ̂d,t converges to ρd almost surely, and θt converges to the fixed point of ΠπTπV .\nProof. We use a three timescales stochastic approximation analysis. The fastest process is d̂µ(s)which converges naturally with time-step O(1\nt ):\nd̂µ,t+1 = 1\nt+ 1\nt∑\nk=0\nesk = 1\nt+ 1 (td̂µ,t + est) = d̂µ,t +\n1\nt+ 1 (est − d̂µ,t). (17)\nThe process d̂µ,t converges almost surely to dµ by the strong law of large numbers. Our next process is ρ̂d,t, which we will show converges a.s. to ρd with d̂µ(s) = dµ(s):\nLemma 4. The process:\nFt = ρt−1(βFt−1 + est−1), n(β) = βn(β) + 1\nρ̂d,t+1(st) = Π∆dµ ( ρ̂d,t(st) + α d t ( F⊤t ρ̂d,t n(β) − ρ̂d,t(st) )) (18)\nConverges almost surely to ρd.\nProof. We follow the notation from (Schuss & Borkar, 2009). We first specify the stochastic approximation using h(x) andMn+1:\nh(ρ̂d,t) =E [ F⊤t ρ̂d,t n(β) |st ] − ρ̂d,t(st) = estY β ρ̂d,t − est ρ̂d,t = est(Y β − I)ρ̂d,t,\nMn+1 = F⊤t ρ̂d,t n(β) − E [ F⊤t ρ̂d,t n(β) |st ] = F⊤t ρ̂d,t n(β) − estY β ρ̂d,t.\n(19)\nNow there are several conditions that must follow - condition on the step sizes, conditions on the Martingale and conditions on the projection. If all of these are met than the process converegs to the fixed point of the projected operator ρd.\nThe step size conditions follow by the theorem’s assumption. Now we move on to the Martingale conditions. Obviously E [Mn+1|st] = 0. In order for E [ ‖Mn+1‖ 2|st ] to be bounded a.s., we use the assumption E [ (βnΓn)2 ] ≤ C.\nSince Ft is the leading factor in E [ ‖Mn+1‖ 2|st ] (the others are naturally bounded depending quadratically on ρ̂d), and Ft = Γ̃ β = (1− β) ∑∞ n=0 β nΓ̃n+1t , the upper bound follows.\nNow let’s consider the projection where we follow the discussion in (Schuss & Borkar, 2009), Section 5.4. Notice that h is Lipschitz and the eigenvalues around the fixed point are non-negative, therefore there’s a stable invariant solution set. In addition, the projection is to a closed convex set ∆dµ , so ρ̂d,t is bounded. Hence, our goal is to show that the projection is Lipschitz and that we can ignore its non-smooth boundary.\nThe projection to the simplex zeros some coordinates and decreases a constant from the other coordinates. If indeed it zeros some coordinates - we are at a problematic area of the space since the projection is not Frechet differentiable there (we are on the boundary of the set). However, because ρd(s) > 0 (Assumption 1), the unprojected ODE repels ρ̂d from these problematic boundaries, and we can assume that after enough the steps the projection is simply a projection to the affine subspace ∑\ns dµ(s)u(s) = 1. In that case the projection is given by: Π∆dµu = (I − 1 ‖dµ‖2 dµd ⊤ µ )(u − 1) + 1\nand its Frechet derivative is Π̄∆dµu = (I − 1 ‖dµ‖2 dµd ⊤ µ )u. This derivative is Lipschitz continuous which means that its composition with h is also Lipschitz .\nHence, the process converges to the solution set of Π̄∆dµh(x) = 0 for Π∆dµx = x. Under these constraints the only fixed point can be ρd (intersection of the c · ρd line with the weighted simplex set ∆dµ).\nFinally, treating the θt process assuming ρ̂d,t already converged to ρd, leaves us with Lemma 1. Since each process depends only on the previous ones, it is enough to show they converge independently as long as the step sizes satisfy the rate constraints."
    }, {
      "heading" : "9.5. Proof of Theorem 2",
      "text" : "If the step sizes hold ∑ t αt = ∑ t α d t = ∞, ∑ t(α 2 t + (α d t )\n2) < ∞, αt αdt\n→ 0, tαdt → 0, and E [ (βnΓnt ) 2|st ] ≤ C for some\nconstant C and every t, n, then after applying COP-TD(0, β) with function approximation satisfying φρ(s) ∈ R k +, ρ̂d,t converges to the fixed point of Π∆Eµ[φρ]ΠφρY β denoted by ρCOPd almost surely, and if θt converges it is to the fixed point of Πdµ◦ρCOPd TπV .\nProof. Similarly to the proof of Theorem , we can analyze the system on 3-time scales. The fastest process is d̂φρ which converges naturally with time-step O(1\nt ):\nd̂φρ,t+1 = 1\nt+ 1\nt∑\nk=0\nφρ(sk) = 1\nt+ 1 (td̂φρ,t + φρ(sk)) = d̂φρ,t +\n1\nt+ 1 (φρ(sk)− d̂φρ,t). (20)\nThe process d̂φρ converges almost surely to Eµ[φρ(s)] by the strong law of large numbers.\nWe now show that ρ̂d,t converges to ρ COP d . The proof follows the same lines as that of Theorem 1, where two things changed: (a) The estimated value ρ̂d,t is now contained in a linear subspace spanned by Φρ, and (b) the projection changed as well from the dµ simplex to the Eµ[φρ(s)] simplex.\nFirst we represent the corresponding A and b of the projected ρd ODE as follows (we assume β = 0, but the results are similar for general β):\nA = Φ⊤ρ Dµ(D −1 µ P ⊤ π Dµ − I)Φρ = Φ ⊤ ρ (P ⊤ π − I)DµΦρ, b = 0. (21)\nWe can now verify that a solution to Ax = b also holds the Projected COP equation: Π φρ dµ YΦρθρ = Φθρ by multiplying it from the left by Φ⊤ρ Dµ:\nΦ⊤ρ Dµ\n[ Π\nφρ dµ YΦρθρ − Φρθρ ] = Φ⊤ρ Dµ [ Φρ ( Φ⊤ρ DµΦρ )−1 Φ⊤ρ Dµ ( D−1µ PπDµ ) Φρθρ − Φρθρ ]\n= Φ⊤ρ PπDµΦρθρ − Φ ⊤ ρ DµΦρθρ = Φ⊤ρ (Pπ − I)DµΦρ\n(22)\nLet’s look on the new projection Π∆Eµ[φρ] . Since we demanded φρ(s) ∈ R k +, this set is close and bounded, so the convergence is guaranteed.\nIn order for the new projectionΠ∆Eµ[φρ] to be Frechet differentiable, we should verify it still avoids the boundaries meaning θρ > 0 coordinate-wise. However, evenwere this not true, we could simply throw away one of the features and get a smaller problem that does hold this condition, keeping the projection Frechet differentiable similarly to before. Subsequently ρ̂d,t converges to the fixed point of Π∆Eµ[φρ]ΠφρY β denoted by ρCOPd almost surely.\nMoving on to the last process, we get the following equations:\nA = lim t→∞ Eµ\n[ ρtρ COP d (st)φt(φt − γφt+1) ⊤ ] = Φ⊤Dµdiag(ρ COP d )(I − γPπ)Φ,\nb = lim t→∞ Eµ\n[ ρtρ COP d (st)φtr ⊤ t |sk = s ] = Φ⊤Dπdiag(ρ COP d )Rπ ,\n(23)\nleading us to the known convergence solution (if indeed the process converge, which is not necessarily true) which is the fixed point of Πdµ◦ρCOPd TπV ."
    }, {
      "heading" : "9.6. Proof of Corollary 1",
      "text" : "Let 0 < ǫ < 1. If (1 − ǫ)ρd ≤ ρ COP d ≤ (1 + ǫ)ρd, then the fixed point of COP-TD(0,β) with function approximation θ COP satisfies the following, where ‖ · ‖∞ is the L∞ induced norm:\n‖θ∗ − θCOP‖∞ ≤ ǫ‖A −1 π Φ ⊤‖∞ ( Rmax + (1 + γ)‖Φ‖∞‖θ COP‖∞ ) , (24)\nwhere Aπ = Φ ⊤Dπ(I − γPπ)Φ, and θ ∗ sets the fixed point of the operator ΠdπTπV .\nProof. If (1− ǫ)ρd ≤ ρ COP d ≤ (1 + ǫ)ρd, then we know that the weights of the projection hold:\n(1− ǫ)dπ ≤ dπ̃ . = dµ ◦ ρ COP d ≤ (1− ǫ)dπ. (25)\nWe write the solution equations for both weight vectors\n(Φ⊤Dπ(I − γPπ)Φ)θ ∗ = Φ⊤DπR (Φ⊤Dπ̃(I − γPπ)Φ)θ COP = Φ⊤Dπ̃R\n(26)\nNow we subtract both equations and add and subtract (Φ⊤Dπ(I − γPπ)Φ)θ COP:\n(Φ⊤Dπ(I − γPπ)Φ)(θ ∗ − θCOP) = Φ⊤(Dπ −Dπ̃)R + (Φ ⊤(Dπ̃ −Dπ)(I − γPπ)Φ)θ COP (27)\nNow we take L∞ norm on both sides, and use induced matrix sub-multiplicative property:\n‖θ∗ − θCOP‖∞ =‖(Φ ⊤Dπ(I − γPπ)Φ) −1 ( Φ⊤(Dπ −Dπ̃)R+ (Φ ⊤(Dπ̃ −Dπ)(I − γPπ)Φ)θ COP ) ‖∞\n≤‖(Φ⊤Dπ(I − γPπ)Φ) −1‖Φ⊤‖∞ ( (Dπ −Dπ̃)R‖∞ + ‖((Dπ̃ −Dπ)(I − γPπ)Φ)θ COP‖∞ ) ≤‖A−1π Φ ⊤‖∞ ( ‖Dπ −Dπ̃‖∞‖R‖∞ + ‖Dπ −Dπ̃‖∞‖I − γPπ‖∞‖Φ‖∞‖θ COP‖∞ ) ≤ǫ‖A−1π Φ ⊤‖∞ ( Rmax + (1 + γ)‖Φ‖∞‖θ COP‖∞ )\n(28)"
    }, {
      "heading" : "9.7. More details on the experiments",
      "text" : "Experiments for Figure 1: 100 states chain MDP, with probability 0.51 to move left / right for the behavior / target policy. Results were taken after T = 1e6 iterations. For COP-TD we used β = 0 and a constant step size 0.5. For Log-COP-TD we used β = 0, γlog = 0.9999 and constant step size 0.5. The experiment was conducted 10 times and the standard deviation is given as shading in the graph.\nFor the mountain car experimentwe used the simulator given by https://jamh-web.appspot.com/download.htm. The state aggregation was obtained by running kmeans with 100 clusters and taking the centers as representative states. The behavior policy was taken to be uniform over the 3 possible actions (-1, 0, 1), and the target policy chose these actions with probabilities (1/6,1/3,1/2) regardless of the state. COP-TD was applied with β = 0 and constant step size 0.01, and Log-COP-TD was applied with β = 0, γlog = 0.9 and constant step size 0.01. Both algorithms ran for T = 1e6 iterations before the estimated ρd was taken.\nExperiments for Figure 2: 100 states chain MDP, with probability 0.51 to move left / right for the behavior / target policy. For both algorithms constant step size 0.5. For Log-COP-TD we used β = 0, γlog = 0.9999 when sweeping on the other parameter. All experiments were conducted 10 times and we show the average result.\nIn the randomized MDP with 32 states we used uniform distribution over transition probabilities for two possible actions, and the target policy had p = 0.75 to choose one action where the behavior policy had p = 0.75 to choose the other action. All experiments were conducted 10 times and we show the average result.\nExperiments for Figure 3 were obtained by running COP-TD, Log-COP-TD, ETD and GTD over 4 setups. The distinct parameters of each algorithm were swiped over to find the best value: COP-TD’s step size and β, Log-COP-TD’s steps size, β and γlog, ETD’s β and GTD’s step size. The step size of the main process and λ were taken to be the same for all algorithms: step size = 0.05 and λ = 0 (obtained also by sweeping over possible values). The simulators for acrobot and pole-balancing were taken from https://jamh-web.appspot.com/download.htm."
    } ],
    "references" : [ {
      "title" : "Application of reinforcement learning to routing in distributed wireless networks: a review",
      "author" : [ "Al-Rawi", "Hasan AA", "Ng", "Ming Ann", "Yau", "KokLim Alvin" ],
      "venue" : "Artificial Intelligence Review,",
      "citeRegEx" : "Al.Rawi et al\\.,? \\Q2015\\E",
      "shortCiteRegEx" : "Al.Rawi et al\\.",
      "year" : 2015
    }, {
      "title" : "Applying reinforcement learning towards automating resource allocation and application scalability in the cloud",
      "author" : [ "Barrett", "Enda", "Howley", "Duggan", "Jim" ],
      "venue" : "Concurrency and Computation: Practice and Experience,",
      "citeRegEx" : "Barrett et al\\.,? \\Q2013\\E",
      "shortCiteRegEx" : "Barrett et al\\.",
      "year" : 2013
    }, {
      "title" : "Dynamic Programming and Optimal Control, Vol II",
      "author" : [ "D. Bertsekas" ],
      "venue" : "Athena Scientific,",
      "citeRegEx" : "Bertsekas,? \\Q2012\\E",
      "shortCiteRegEx" : "Bertsekas",
      "year" : 2012
    }, {
      "title" : "Projection onto a simplex",
      "author" : [ "Chen", "Yunmei", "Ye", "Xiaojing" ],
      "venue" : "arXiv preprint arXiv:1101.6081,",
      "citeRegEx" : "Chen et al\\.,? \\Q2011\\E",
      "shortCiteRegEx" : "Chen et al\\.",
      "year" : 2011
    }, {
      "title" : "Off-policy learning with eligibility traces: A survey",
      "author" : [ "Geist", "Matthieu", "Scherrer", "Bruno" ],
      "venue" : "The Journal of Machine Learning Research,",
      "citeRegEx" : "Geist et al\\.,? \\Q2014\\E",
      "shortCiteRegEx" : "Geist et al\\.",
      "year" : 2014
    }, {
      "title" : "Importance-weighted least-squares probabilistic classifier for covariate shift adaptation with application to human activity",
      "author" : [ "Hachiya", "Hirotaka", "Sugiyama", "Masashi", "Ueda", "Naonori" ],
      "venue" : "recognition. Neurocomputing,",
      "citeRegEx" : "Hachiya et al\\.,? \\Q2012\\E",
      "shortCiteRegEx" : "Hachiya et al\\.",
      "year" : 2012
    }, {
      "title" : "Generalized emphatic temporal difference learning: Bias-variance analysis",
      "author" : [ "Hallak", "Assaf", "Tamar", "Aviv", "Munos", "Remi", "Mannor", "Shie" ],
      "venue" : "arXiv preprint arXiv:1509.05172,",
      "citeRegEx" : "Hallak et al\\.,? \\Q2015\\E",
      "shortCiteRegEx" : "Hallak et al\\.",
      "year" : 2015
    }, {
      "title" : "Reinforcement learning in robotics: A survey",
      "author" : [ "Kober", "Jens", "Bagnell", "J Andrew", "Peters", "Jan" ],
      "venue" : "The International Journal of Robotics Research,",
      "citeRegEx" : "Kober et al\\.,? \\Q2013\\E",
      "shortCiteRegEx" : "Kober et al\\.",
      "year" : 2013
    }, {
      "title" : "Td-gamma: Re-evaluating complex backups in temporal difference learning",
      "author" : [ "Konidaris", "George", "Niekum", "Scott", "Thomas", "Philip S" ],
      "venue" : "In Advances in Neural Information Processing Systems",
      "citeRegEx" : "Konidaris et al\\.,? \\Q2011\\E",
      "shortCiteRegEx" : "Konidaris et al\\.",
      "year" : 2011
    }, {
      "title" : "Stochastic approximation and recursive algorithms and applications, volume 35",
      "author" : [ "Kushner", "Harold", "Yin", "G George" ],
      "venue" : "Springer Science & Business Media,",
      "citeRegEx" : "Kushner et al\\.,? \\Q2003\\E",
      "shortCiteRegEx" : "Kushner et al\\.",
      "year" : 2003
    }, {
      "title" : "Off-policy learning based on weighted importance sampling with linear computational complexity",
      "author" : [ "Mahmood", "A Rupam", "Sutton", "Richard S" ],
      "venue" : "In Conference on Uncertainty in Artificial Intelligence,",
      "citeRegEx" : "Mahmood et al\\.,? \\Q2015\\E",
      "shortCiteRegEx" : "Mahmood et al\\.",
      "year" : 2015
    }, {
      "title" : "Off-policy temporal-difference learning with function approximation",
      "author" : [ "Precup", "Doina", "Sutton", "Richard S", "Dasgupta", "Sanjoy" ],
      "venue" : "In ICML,",
      "citeRegEx" : "Precup et al\\.,? \\Q2001\\E",
      "shortCiteRegEx" : "Precup et al\\.",
      "year" : 2001
    }, {
      "title" : "Stochastic approximation: A dynamical systems viewpoint",
      "author" : [ "Schuss", "Zeev", "Borkar", "Vivek S" ],
      "venue" : null,
      "citeRegEx" : "Schuss et al\\.,? \\Q2009\\E",
      "shortCiteRegEx" : "Schuss et al\\.",
      "year" : 2009
    }, {
      "title" : "Reinforcement learning: An introduction",
      "author" : [ "R.S. Sutton", "A. Barto" ],
      "venue" : null,
      "citeRegEx" : "Sutton and Barto,? \\Q1998\\E",
      "shortCiteRegEx" : "Sutton and Barto",
      "year" : 1998
    }, {
      "title" : "An emphatic approach to the problem of off-policy temporaldifference learning",
      "author" : [ "R.S. Sutton", "A.R. Mahmood", "M. White" ],
      "venue" : null,
      "citeRegEx" : "Sutton et al\\.,? \\Q2015\\E",
      "shortCiteRegEx" : "Sutton et al\\.",
      "year" : 2015
    }, {
      "title" : "A new q (lambda) with interim forward view and monte carlo equivalence",
      "author" : [ "Sutton", "Rich", "Mahmood", "Ashique R", "Precup", "Doina", "Hasselt", "Hado V" ],
      "venue" : "In Proceedings of the 31st International Conference on Machine Learning",
      "citeRegEx" : "Sutton et al\\.,? \\Q2014\\E",
      "shortCiteRegEx" : "Sutton et al\\.",
      "year" : 2014
    }, {
      "title" : "Learning to predict by the methods of temporal differences",
      "author" : [ "Sutton", "Richard S" ],
      "venue" : "Machine learning,",
      "citeRegEx" : "Sutton and S.,? \\Q1988\\E",
      "shortCiteRegEx" : "Sutton and S.",
      "year" : 1988
    }, {
      "title" : "A convergent o(n) temporal-difference algorithm for offpolicy learning with linear function approximation",
      "author" : [ "Sutton", "Richard S", "Maei", "Hamid R", "Szepesvári", "Csaba" ],
      "venue" : "In Advances in neural information processing systems,",
      "citeRegEx" : "Sutton et al\\.,? \\Q2009\\E",
      "shortCiteRegEx" : "Sutton et al\\.",
      "year" : 2009
    }, {
      "title" : "Lifetime value marketing using reinforcement learning",
      "author" : [ "Theocharous", "Georgios", "Hallak", "Assaf" ],
      "venue" : "RLDM",
      "citeRegEx" : "Theocharous et al\\.,? \\Q2013\\E",
      "shortCiteRegEx" : "Theocharous et al\\.",
      "year" : 2013
    }, {
      "title" : "High confidence policy improvement",
      "author" : [ "Thomas", "Philip", "Theocharous", "Georgios", "Ghavamzadeh", "Mohammad" ],
      "venue" : "In Proceedings of the 32nd International Conference on Machine Learning",
      "citeRegEx" : "Thomas et al\\.,? \\Q2015\\E",
      "shortCiteRegEx" : "Thomas et al\\.",
      "year" : 2015
    }, {
      "title" : "Policy evaluation using the omega-return",
      "author" : [ "Thomas", "Philip S", "Niekum", "Scott", "Theocharous", "Georgios", "Konidaris", "George" ],
      "venue" : "In Advances in Neural Information Processing Systems",
      "citeRegEx" : "Thomas et al\\.,? \\Q2015\\E",
      "shortCiteRegEx" : "Thomas et al\\.",
      "year" : 2015
    }, {
      "title" : "An analysis of temporal-difference learning with function approximation",
      "author" : [ "Tsitsiklis", "John N", "Van Roy", "Benjamin" ],
      "venue" : "Automatic Control, IEEE Transactions on,",
      "citeRegEx" : "Tsitsiklis et al\\.,? \\Q1997\\E",
      "shortCiteRegEx" : "Tsitsiklis et al\\.",
      "year" : 1997
    }, {
      "title" : "Off-policy td (λ) with a true online equivalence",
      "author" : [ "van Hasselt", "Hado", "Mahmood", "A Rupam", "Sutton", "Richard S" ],
      "venue" : "In Proceedings of the 30th Conference on Uncertainty in Artificial Intelligence, Quebec City,",
      "citeRegEx" : "Hasselt et al\\.,? \\Q2014\\E",
      "shortCiteRegEx" : "Hasselt et al\\.",
      "year" : 2014
    }, {
      "title" : "Investigating practical, linear temporal difference learning",
      "author" : [ "White", "Adam", "Martha" ],
      "venue" : "arXiv preprint arXiv:1602.08771,",
      "citeRegEx" : "White et al\\.,? \\Q2016\\E",
      "shortCiteRegEx" : "White et al\\.",
      "year" : 2016
    }, {
      "title" : "On convergence of emphatic temporal-difference learning",
      "author" : [ "H. Yu" ],
      "venue" : "In COLT,",
      "citeRegEx" : "Yu,? \\Q2015\\E",
      "shortCiteRegEx" : "Yu",
      "year" : 2015
    } ],
    "referenceMentions" : [ {
      "referenceID" : 7,
      "context" : "Reinforcement Learning (RL) techniques were successfully applied in fields such as robotics, games, marketing and more (Kober et al., 2013; Al-Rawi et al., 2015; Barrett et al., 2013).",
      "startOffset" : 119,
      "endOffset" : 183
    }, {
      "referenceID" : 0,
      "context" : "Reinforcement Learning (RL) techniques were successfully applied in fields such as robotics, games, marketing and more (Kober et al., 2013; Al-Rawi et al., 2015; Barrett et al., 2013).",
      "startOffset" : 119,
      "endOffset" : 183
    }, {
      "referenceID" : 1,
      "context" : "Reinforcement Learning (RL) techniques were successfully applied in fields such as robotics, games, marketing and more (Kober et al., 2013; Al-Rawi et al., 2015; Barrett et al., 2013).",
      "startOffset" : 119,
      "endOffset" : 183
    }, {
      "referenceID" : 14,
      "context" : "Our algorithm resembles (Sutton et al., 2015)’s Emphatic TD that was extended by (Hallak et al.",
      "startOffset" : 24,
      "endOffset" : 45
    }, {
      "referenceID" : 6,
      "context" : ", 2015)’s Emphatic TD that was extended by (Hallak et al., 2015) to the general parametric form ETD(λ,β).",
      "startOffset" : 43,
      "endOffset" : 64
    }, {
      "referenceID" : 2,
      "context" : "Notice that Equation 1 does not specify an on-line implementation since R (n) t,st depends on future observations, however there exists a compact on-line implementation using eligibility traces (Bertsekas & Tsitsiklis (1996) for on-line TD(λ), and Sutton et al.",
      "startOffset" : 195,
      "endOffset" : 225
    }, {
      "referenceID" : 2,
      "context" : "Notice that Equation 1 does not specify an on-line implementation since R (n) t,st depends on future observations, however there exists a compact on-line implementation using eligibility traces (Bertsekas & Tsitsiklis (1996) for on-line TD(λ), and Sutton et al. (2014), Sutton et al.",
      "startOffset" : 195,
      "endOffset" : 269
    }, {
      "referenceID" : 2,
      "context" : "Notice that Equation 1 does not specify an on-line implementation since R (n) t,st depends on future observations, however there exists a compact on-line implementation using eligibility traces (Bertsekas & Tsitsiklis (1996) for on-line TD(λ), and Sutton et al. (2014), Sutton et al. (2015) for off-policy TD(λ)).",
      "startOffset" : 195,
      "endOffset" : 291
    }, {
      "referenceID" : 2,
      "context" : "and is a γ(1−λ) 1−λγ -contraction (Bertsekas, 2012).",
      "startOffset" : 34,
      "endOffset" : 51
    }, {
      "referenceID" : 5,
      "context" : "we call ρd the covariate shift ratio (as denoted under different settings by (Hachiya et al., 2012)).",
      "startOffset" : 77,
      "endOffset" : 99
    }, {
      "referenceID" : 11,
      "context" : "Among these are full IS (Precup et al., 2001) and ETD(λ,β) (Sutton et al.",
      "startOffset" : 24,
      "endOffset" : 45
    }, {
      "referenceID" : 14,
      "context" : ", 2001) and ETD(λ,β) (Sutton et al., 2015).",
      "startOffset" : 21,
      "endOffset" : 42
    }, {
      "referenceID" : 11,
      "context" : "For example, full IS-TD by (Precup et al., 2001) examines the ratio between the probabilities of the trajectory under both policies:",
      "startOffset" : 27,
      "endOffset" : 48
    }, {
      "referenceID" : 24,
      "context" : "Notice that a theorem is only given for λ = 0, convergence results for general λ should follow the work by Yu (2015). A possible criticism on COP-TD(0,β) is that it is not actually consistent, since in order to be consistent the original state space has to be small, in which case every off-policy algorithm is consistent as well.",
      "startOffset" : 107,
      "endOffset" : 117
    }, {
      "referenceID" : 13,
      "context" : "Recently, Sutton et al. (2015) had suggested an algorithm for off-policy evaluation called Emphatic TD.",
      "startOffset" : 10,
      "endOffset" : 31
    }, {
      "referenceID" : 6,
      "context" : "Their algorithm was later on extended by Hallak et al. (2015) and renamed ETD(λ, β), which was shown to perform extremely well empirically by White & White (2016).",
      "startOffset" : 41,
      "endOffset" : 62
    }, {
      "referenceID" : 6,
      "context" : "Their algorithm was later on extended by Hallak et al. (2015) and renamed ETD(λ, β), which was shown to perform extremely well empirically by White & White (2016). ETD(0, β) can be represented as:",
      "startOffset" : 41,
      "endOffset" : 163
    }, {
      "referenceID" : 24,
      "context" : "As mentioned before, ETD(λ, β) converges to the fixed point of ΠfT λ π (Yu, 2015), where f = E [Ft|st] = (I − βPπ) dμ.",
      "startOffset" : 71,
      "endOffset" : 81
    }, {
      "referenceID" : 6,
      "context" : "Error bounds can be achieved by showing that the operator ΠfT λ π is a contraction under certain requirements on β and that the variance of Ft is directly related to β as well (Hallak et al., 2015) (and thus affects the convergence rate of the process).",
      "startOffset" : 176,
      "endOffset" : 197
    }, {
      "referenceID" : 8,
      "context" : "Subsequently, in Konidaris et al. (2011) Assumption 4 was relaxed and instead a closed form approximation of the variance was proposed.",
      "startOffset" : 17,
      "endOffset" : 41
    }, {
      "referenceID" : 8,
      "context" : "Subsequently, in Konidaris et al. (2011) Assumption 4 was relaxed and instead a closed form approximation of the variance was proposed. In a follow-up paper by Thomas et al. (2015b), the second assumption was also removed and the weights were instead given as: wn = We have conducted several experiments with an altered ETD and indeed obtained better results compared with the original, these experiments are outside the scope of the paper.",
      "startOffset" : 17,
      "endOffset" : 182
    }, {
      "referenceID" : 8,
      "context" : "Variance Weighted Γt As was shown by Konidaris et al. (2011), we can use statedependent weights instead of β exponents to obtain better estimates.",
      "startOffset" : 37,
      "endOffset" : 61
    }, {
      "referenceID" : 19,
      "context" : "While this solution is impractical in problems with large state spaces parameterizing or approximating these variances (similarly to Thomas et al. (2015b)) could improve performance in specific applications.",
      "startOffset" : 133,
      "endOffset" : 155
    }, {
      "referenceID" : 6,
      "context" : "While a plethora of algorithms were suggested so far, ETD(λ, β) by Hallak et al. (2015) has perhaps the simplest formulation and theoretical properties.",
      "startOffset" : 67,
      "endOffset" : 88
    } ],
    "year" : 2017,
    "abstractText" : "The problem of on-line off-policy evaluation (OPE) has been actively studied in the last decade due to its importance both as a stand-alone problem and as a module in a policy improvement scheme. However, most Temporal Difference (TD) based solutions ignore the discrepancy between the stationary distribution of the behavior and target policies and its effect on the convergence limit when function approximation is applied. In this paper we propose the Consistent Off-Policy Temporal Difference (COP-TD(λ, β)) algorithm that addresses this issue and reduces this bias at some computational expense. We show that COP-TD(λ, β) can be designed to converge to the same value that would have been obtained by using on-policy TD(λ) with the target policy. Subsequently, the proposed scheme leads to a related and promising heuristic we call logCOP-TD(λ, β). Both algorithms have favorable empirical results to the current state of the art online OPE algorithms. Finally, our formulation sheds some new light on the recently proposed Emphatic TD learning.",
    "creator" : "LaTeX with hyperref package"
  }
}