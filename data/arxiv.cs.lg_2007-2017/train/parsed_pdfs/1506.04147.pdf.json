{
  "name" : "1506.04147.pdf",
  "metadata" : {
    "source" : "CRF",
    "title" : "On the accuracy of self-normalized log-linear models",
    "authors" : [ "Jacob Andreas", "Maxim Rabinovich", "Dan Klein", "Michael I. Jordan" ],
    "emails" : [ "jda@cs.berkeley.edu", "rabinovich@cs.berkeley.edu", "klein@cs.berkeley.edu", "jordan@cs.berkeley.edu" ],
    "sections" : [ {
      "heading" : "1 Introduction",
      "text" : "Log-linear models, a general class that includes conditional random fields (CRFs) and generalized linear models (GLMs), offer a flexible yet tractable approach modeling conditional probability distributions p(x|y) [1, 2]. When the set of possible y values is large, however, the computational cost of computing a normalizing constant for each x can be prohibitive—involving a summation with many terms, a high-dimensional integral or an expensive dynamic program.\nThe machine translation community has recently described several procedures for training “selfnormalized” log-linear models [3, 4]. The goal of self-normalization is to choose model parameters that simultaneously yield accurate predictions and produce normalizers clustered around unity. Model scores can then be used as approximate surrogates for probabilities, obviating the computation normalizer computation.\nIn particular, given a model of the form\npη(y | x) = eη TT (y, x)−A(η, x) (1)\nwith A (η, x) = ∑ y∈Y eη TT (y, x) , (2)\nwe seek a setting of η such that A(x, η) is close enough to zero (with high probability under p(x)) to be ignored.\n∗Authors contributed equally.\nar X\niv :1\n50 6.\n04 14\n7v 1\n[ st\nat .M\nL ]\n1 2\nJu n\n20 15\nThis paper aims to understand the theoretical properties of self-normalization. Empirical results have already demonstrated the efficacy of this approach—for discrete models with many output classes, it appears that normalizer values can be made nearly constant without sacrificing too much predictive accuracy, providing dramatic efficiency increases at minimal performance cost.\nThe broad applicability of self-normalization makes it likely to spread to other large-scale applications of log-linear models, including structured prediction (with combinatorially many output classes) and regression (with continuous output spaces). But it is not obvious that we should expect such approaches to be successful: the number of inputs (if finite) can be on the order of millions, the geometry of the resulting input vectors x highly complex, and the class of functions A(η, x) associated with different inputs quite rich. To find to find a nontrivial parameter setting with A(η, x) roughly constant seems challenging enough; to require that the corresponding η also lead to good classification results seems too much. And yet for many input distributions that arise in practice, it appears possible to choose η to makeA(η, x) nearly constant without having to sacrifice classification accuracy.\nOur goal is to bridge the gap between theoretical intuition and practical experience. Previous work [5] bounds the sample complexity of self-normalizing training procedures for a restricted class of models, but leaves open the question of how self-normalization interacts with the predictive power of the learned model. This paper seeks to answer that question. We begin by generalizing the previously-studied model to a much more general class of distributions, including distributions with continuous support (Section 3). Next, we provide what we believe to be the first characterization of the interaction between self-normalization and model accuracy Section 4. This characterization is given from two perspectives:\n• a bound on the “likelihood gap” between self-normalized and unconstrained models • a conditional distribution provably hard to represent with a self-normalized model\nIn Figure 5, we present empirical evidence that these bounds correctly characterize the difficulty of self-normalization, and in the conclusion we survey a set of open problems that we believe merit further investigation."
    }, {
      "heading" : "2 Problem background",
      "text" : "The immediate motivation for this work is a procedure proposed to speed up decoding in a machine translation system with a neural-network language model [3]. The language model used is a standard feed-forward neural network, with a “softmax” output layer that turns the network’s predictions into a distribution over the vocabulary, where each probability is log-proportional to its output activation. It is observed that with a sufficiently large vocabulary, it becomes prohibitive to obtain probabilities from this model (which must be queried millions of times during decoding). To fix this, the language model is trained with the following objective:\nmax W ∑ i [ N(yi|xi;W )− log ∑ y′ eN(y ′|xi;W ) − α ( log ∑ y′ eN(y ′|xi;W ) )2] whereN(y|x;W ) is the response of output y in the neural net with weightsW given an input x. From a Lagrangian perspective, the extra penalty term simply confines the W to the set of “empirically normalizing” parameters, for which all log-normalizers are close (in squared error) to the origin. For a suitable choice of α, it is observed that the trained network is simultaneously accurate enough to produce good translations, and close enough to self-normalized that the raw scores N(yi|xi) can be used in place of log-probabilities without substantial further degradation in quality.\nWe seek to understand the observed success of these models in finding accurate, normalizing parameter settings. While it is possible to derive bounds of the kind we are interested in for general neural networks [6], in this paper we work with a simpler linear parameterization that we believe captures the interesting aspects of this problem. 1\n1It is possible to view a log-linear model as a single-layer network with a softmax output. More usefully, all of the results presented here apply directly to trained neural nets in which the last layer only is retrained to self-normalize [7]."
    }, {
      "heading" : "Related work",
      "text" : "The approach described at the beginning of this section is closely related to an alternative selfnormalization trick described based on noise-contrastive estimation (NCE) [8]. NCE is an alternative to direct optimization of likelihood, instead training a classifier to distinguish between true samples from the model, and “noise” samples from some other distribution. The structure of the training objective makes it possible to replace explicit computation of each log-normalizer with an estimate. In traditional NCE, these values are treated as part of the parameter space, and estimated simultaneously with the model parameters; there exist guarantees that the normalizer estimates will eventually converge to their true values. It is instead possible to fix all of these estimates to one. In this case, empirical evidence suggests that the resulting model will also exhibit self-normalizing behavior [4].\nA host of other techniques exist for solving the computational problem posed by the log-normalizer. Many of these involve approximating the associated sum or integral using quadrature [9], herding [10], or Monte Carlo methods [11]. For the special case of discrete, finite output spaces, an alternative approach—the hierarchical softmax—is to replace the large sum in the normalizer with a series of binary decisions [12]. The output classes are arranged in a binary tree, and the probability of generating a particular output is the product of probabilities along the edges leading to it. This reduces the cost of computing the normalizer fromO(k) toO(log k). While this limits the set of distributions that can be learned, and still requires greater-than-constant time to compute normalizers, it appears to work well in practice. It cannot, however, be applied to problems with continuous output spaces."
    }, {
      "heading" : "3 Self-normalizable distributions",
      "text" : "We begin by providing a slightly more formal characterization of a general log-linear model:\nDefinition 1 (Log-linear models). Given a space of inputs X , a space of outputs Y , a measure µ on Y , a nonnegative function h : Y → R, and a function T : X × Y → Rd that is µ-measurable with respect to its second argument, we can define a log-linear model indexed by parameters η ∈ Rd, with the form\npη(y|x) = h(y)eη >T (x,y)−A(x,η) , (3)\nwhere\nA(x, η) ∆ = log ∫ Y h(y)eη >T (x,y) dµ(y) . (4)\nIf A(x, η) ≤ ∞, then ∫ y pη(y|x) dµ(y) = 1, and pη(y|x) is a probability density over Y .2\nWe next formalize our notion of a self-normalized model.\nDefinition 2 (Self-normalized models). The log-linear model pη(y|x) is self-normalized with respect to a set S ⊂ X if for all x ∈ S, A(x, η) = 0. In this case we say that S is self-normalizable, and η is self-normalizing w.r.t. S.\nAn example of a normalizable set is shown in Figure 1a, and we provide additional examples below:\n2Some readers may be more familiar with generalized linear models, which also describe exponential family distributions with a linear dependence on input. The presentation here is strictly more general, and has a few notational advantages: it makes explicit the dependence of A on x and η but not y, and lets us avoid tedious bookkeeping involving natural and mean parameterizations. [13]\nExample. Suppose S = {log 2,− log 2} , Y = {−1, 1}\nT (x, y) = [xy, 1]\nη = (1, log(2/5)) ."
    }, {
      "heading" : "Then for either x ∈ S,",
      "text" : "A(x, η) = log(elog 2+log(2/5) + e− log 2+log(2/5))\n= log((2/5)(2 + 1/2))\n= 0 ,\nand η is self-normalizing with respect to S.\nIt is also easy to choose parameters that do not result in a self-normalized distribution, and in fact to construct a target distribution which cannot be self-normalized:\nExample. Suppose\nX = {(1, 0), (0, 1), (1, 1)} Y = {−1, 1}\nT (x, y) = (x1y, x2y, 1)\nThen there is no η such that A(x, η) = 0 for all x, and A(x, η) is constant if and only if η = 0.\nAs previously motivated, downstream uses of these models may be robust to small errors resulting from improper normalization, so it would be useful to generalize this definition of normalizable distributions to distributions that are only approximately normalizable. Exact normalizability of the conditional distribution is a deterministic statement—there either does or does not exist some x that violates the constraint. In Figure 1a, for example, it suffices to have a single x off of the indicated surface to make a set non-normalizable. Approximate normalizability, by contrast, is inherently a probabilistic statement, involving a distribution p(x) over inputs. Note carefully that\nwe are attempting to represent p(y|x) but have no representation of (or control over) p(x), and that approximate normalizability depends on p(x) but not p(y|x). Informally, if some input violates the self-normalization constraint by a large margin, but occurs only very infrequently, there is no problem; instead we are concerned with expected deviation. It is also at this stage that the distinction between penalization of the normalizer vs. log-normalizer becomes important. The normalizer is necessarily bounded below by zero (so overestimates might appear much worse than underestimates), while the log-normalizer is unbounded in both directions. For most applications we are concerned with log probabilities and log-odds ratios, for which an expected normalizer close to zero is just as bad as one close to infinity. Thus the log-normalizer is the natural choice of quantity to penalize. Definition 3 (Approximately self-normalized models). The log-linear distribution pη(y|x) is δapproximately normalized with respect to a distribution p(x) over X if E[A(X, η)2] < δ2. In this case we say that p(x) is δ-approximately self-normalizable, and η is δ-approximately self-normalizing.\nThe sets of δ-approximately self-normalizing parameters for a fixed input distribution and feature function are depicted in Figure 1b. Unlike self-normalizable sets of inputs, self-normalizing and approximately self-normalizing sets of parameters may have complex geometry.\nThroughout this paper, we will assume that vectors of sufficient statistics T (x, y) have bounded `2 norm at most R, natural parameter vectors η have `2 norm at most B (that is, they are Ivanovregularized), and that vectors of both kinds lie in Rd. Finally, we assume that all input vectors have a constant feature—in particular, that x0 = 1 for every x (with corresponding weight η0). 3\nThe first question we must answer is whether the problem of training self-normalized models is feasible at all—that is, whether there exist any exactly self-normalizable data distributions p(x), or at least δ-approximately self-normalizable distributions for small δ. Section 3 already gave an example of an exactly normalizable distribution. In fact, there are large classes of both exactly and approximately normalizable distributions. Observation. Given some fixed η, consider the set Sη = {x ∈ X : A(x, η) = 0}. Any distribution p(x) supported on Sη is normalizable. Additionally, every self-normalizable distribution is characterized by at least one such η.\nThis definition provides a simple geometric characterization of self-normalizable distributions. An example solution set is shown in Figure 1a. More generally, if y is discrete and T (x, y) consists of |Y| repetitions of a fixed feature function t(x) (as in Figure 1a), then we can write\nA(x, η) = log ∑ y∈Y eη > y t(x). (5)\nProvided η>y t(x) is convex in x for each ηy , the level sets of A as a function of x form the boundaries of convex sets. In particular, exactly normalizable sets are always the boundaries of convex regions, as in the simple example Figure 1a.\nWe do not, in general, expect real-world datasets to be supported on the precise class of selfnormalizable surfaces. Nevertheless, it is very often observed that data of practical interest lie on other low-dimensional manifolds within their embedding feature spaces. Thus we can ask whether it is sufficient for a target distribution to be well-approximated by a self-normalizing one. We begin by constructing an appropriate measurement of the quality of this approximation. Definition 4 (Closeness). An input distribution p(x) is D-close to a set S if\nE [ inf x∗∈S sup y∈Y ||T (X, y)− T (x∗, y)||2 ] ≤ D (6)\nIn other words, p(x) is D-close to S if a random sample from p is no more than a distance D from S in expectation. Now we can relate the quality of this approximation to the level of self-normalization achieved. Generalizing a result from [5], we have:\n3It will occasionally be instructive to consider the special case where X is the Boolean hypercube, and we will explicitly note where this assumption is made. Otherwise all results apply to general distributions, both continuous and discrete.\nProposition 1. Suppose p(x) is D-close to {x : A(x, η) = 1}. Then p(x) is BD-approximately self-normalizable (recalling that ||x||2 ≤ B).\n(Proofs for this section may be found in Appendix A.)\nThe intuition here is that data distributions that place most of their mass in feature space close to normalizable sets are approximately normalizable on the same scale."
    }, {
      "heading" : "4 Normalization and model accuracy",
      "text" : "So far our discussion has concerned the problem of finding conditional distributions that selfnormalize, without any concern for how well they actually perform at modeling the data. Here the relationship between the approximately self-normalized distribution and the true distribution p(y|x) (which we have so far ignored) is essential. Indeed, if we are not concerned with making a good model it is always trivial to make a normalized one—simply take η = 0 and then scale η0 appropriately! We ultimately desire both good self-normalization and good data likelihood, and in this section we characterize the tradeoff between maximizing data likelihood and satisfying a self-normalization constraint.\nWe achieve this characterization by measuring the likelihood gap between the classical maximum likelihood estimator, and the MLE subject to a self-normalization constraint. Specifically, given pairs ((x1, y1), (x2, y2), . . . , (xn, yn)), let `(η|x, y) = ∑ i log pη(yi|xi). Then define\nη̂ = arg max η\n`(η|x, y) (7)\nη̂δ = arg max η:V (η)≤δ\n`(η|x, y) (8)\n(where V (η) = 1n ∑ iA(xi, η) 2).\nWe would like to obtain a bound on the likelihood gap, which we define as the quantity\n∆`(η̂, η̂δ) = 1\nn (`(η̂|x, y)− `(η̂δ|x, y)) . (9)\nWe claim: Theorem 2. Suppose Y has finite measure. Then asymptotically as n→∞\n∆`(η̂, η̂δ) ≤ (\n1− δ R||η̂||2\n) EKL(pη(·|X) || Unif) . (10)\n(Proofs for this section may be found in Appendix B.)\nThis result lower-bounds the likelihood at η̂δ by explicitly constructing a scaled version of η̂ that satisfies the self-normalization constraint. Specifically, if η is chosen so that normalizers are penalized for distance from logµ(Y) (e.g. the logarithm of the number of classes in the finite case), then any increase in η along the span of the data is guaranteed to increase the penalty. From here it is possible to choose an α ∈ (0, 1) such that αη̂ satisfies the constraint. The likelihood at αη̂ is necessarily less than `(η̂δ|x, y), and can be used to obtain the desired lower bound. Thus at one extreme, distributions close to uniform can be self-normalized with little loss of likelihood. What about the other extreme—distributions “as far from uniform as possible”? With suitable assumptions about the form of pη̂(y|x), we can use the same construction of a self-normalizing parameter to achieve an alternative characterization for distributions that are close to deterministic: Proposition 3. Suppose that X is a subset of the Boolean hypercube, Y is finite, and T (x, y) is the conjunction of each element of x with an indicator on the output class. Suppose additionally that in every input x, pη̂(y|x) makes a unique best prediction—that is, for each x ∈ X , there exists a unique y∗ ∈ Y such that whenever y 6= y∗, η>T (x, y∗) > η>T (x, y). Then\n∆`(η̂, η̂δ) ≤ b ( ||η||2 − δ\nR\n)2 e−cδ/R (11)\nfor distribution-dependent constants b and c.\nThis result is obtained by representing the constrained likelihood with a second-order Taylor expansion about the true MLE. All terms in the likelihood gap vanish except for the remainder; this can be upper-bounded by the ||η̂δ||22 times the largest eigenvalue the feature covariance matrix at η̂δ , which in turn is bounded by e−cδ/R.\nThe favorable rate we obtain for this case indicates that “all-nonuniform” distributions are also an easy class for self-normalization. Together with Theorem 2, this suggests that hard distributions must have some mixture of uniform and nonuniform predictions for different inputs. This is supported by the results in Section 4.\nThe next question is whether there is a corresponding lower bound; that is, whether there exist any conditional distributions for which all nearby distributions are provably hard to self-normalize. The existence of a direct analog of Theorem 2 remains an open problem, but we make progress by developing a general framework for analyzing normalizer variance.\nOne key issue is that while likelihoods are invariant to certain changes in the natural parameters, the log normalizers (and therefore their variance) is far from invariant. We therefore focus on equivalence classes of natural parameters, as defined below. Throughout, we will assume a fixed distribution p(x) on the inputs x. Definition 5 (Equivalence of parameterizations). Two natural parameter values η and η′ are said to be equivalent (with respect to an input distribution p(x)), denoted η ∼ η′ if\npη(y|X) = pη′(y|X) a.s. p(x)\nWe can then define the optimal log normalizer variance for the distribution associated with a natural parameter value. Definition 6 (Optimal variance). We define the optimal log normalizer variance of the log-linear model associated with a natural parameter value η by\nV ∗(η) = inf η′∼η Varp(x) [A(X, η)] .\nWe now specialize to the case where Y is finite with |Y| = K and where T : Y ×X → RKd satisfies T (k, x)k′j = δkk′xj .\nThis is an important special case that arises, for example, in multi-way logistic regression. In this setting, we can show that despite the fundamental non-identifiability of the model, the variance can still be shown to be high under any parameterization of the distribution. Theorem 4. Let X = {0, 1}d and let the input distribution p(x) be uniform on X . There exists an η0 ∈ RKd such that for η = αη0, α > 0,\nV ∗(η) ≥ ||η||22\n32d(d− 1) − 4Ke−\n√ 1− 1\nd ||η||2\n2(d−1) ||η||2 ."
    }, {
      "heading" : "5 Experiments",
      "text" : "The high-level intuition behind the results in the preceding section can be summarized as follows: 1) for predictive distributions that are in expectation high-entropy or low-entropy, self-normalization results in a relatively small likelihood gap; 2) for mixtures of high- and low-entropy distributions, self-normalization may result in a large likelihood gap. More generally, we expect that an increased tolerance for normalizer variance will be associated with a decreased likelihood gap.\nIn this section we provide experimental confirmation of these predictions. We begin by generating a set of random sparse feature vectors, and an initial weight vector η0. In order to produce a sequence of label distributions that smoothly interpolate between low-entropy and high-entropy, we introduce a temperature parameter τ , and for various settings of τ draw labels from pτη. We then fit a selfnormalized model to these training pairs. In addition to the synthetic data, we compare our results to empirical data [3] from a self-normalized language model.\nFigure 2a plots the tradeoff between the likelihood gap and the error in the normalizer, under various distributions (characterized by their KL from uniform). Here the tradeoff between self-normalization\n∆`\n0  \n0.05  \n0.1  \n0.15  \n0.2  \n0   0.5   1   1.5  \nKL=2.6  \nKL=5.0  \nLM  \nδ\n(a) Normalization / likelihood tradeoff. As the normalization constraint δ is relaxed, the likelihood gap ∆` decreases. Lines marked “KL=” are from synthetic data; the line marked “LM” is from [3].\n∆`\nEKL(pη||Unif) (b) Likelihood gap as a function of expected divergence from the uniform distribution. As predicted by theory, the likelihood gap increases, then decreases, as predictive distributions become more peaked.\nFigure 2: Experimental results\nand model accuracy can be seen—as the normalization constraint is relaxed, the likelihood gap decreases.\nFigure 2b shows how the likelihood gap varies as a function of the quantity EKL(pη(·|X)||Unif). As predicted, it can be seen that both extremes of this quantity result in small likelihood gaps, while intermediate values result in large likelihood gaps."
    }, {
      "heading" : "6 Conclusions",
      "text" : "Motivated by the empirical success of self-normalizing parameter estimation procedures for log-linear models, we have attempted to establish a theoretical basis for the understanding of such procedures. We have characterized both self-normalizable distributions, by constructing provably easy examples, and self-normalizing training procedures, by bounding the loss of likelihood associated with selfnormalization.\nWhile we have addressed many of the important first-line theoretical questions around selfnormalization, this study of the problem is by no means complete. We hope this family of problems will attract further study in the larger machine learning community; toward that end, we provide the following list of open questions:\n1. How else can the approximately self-normalizable distributions be characterized? The class of approximately normalizable distributions we have described is unlikely to correspond perfectly to real-world data. We expect that Proposition 1 can be generalized to other parametric classes, and relaxed to accommodate spectral or sparsity conditions.\n2. Are the upper bounds in Theorem 2 or Proposition 3 tight? Our constructions involve relating the normalization constraint to the `2 norm of η, but in general some parameters can have very large norm and still give rise to almost-normalized distributions.\n3. Do corresponding lower bounds exist? While it is easy to construct of exactly selfnormalizable distributions (which suffer no loss of likelihood), we have empirical evidence that hard distributions also exist. It would be useful to lower-bound the loss of likelihood in terms of some simple property of the target distribution.\n4. Is the hard distribution in Theorem 4 stable? This is related to the previous question. The existence of high-variance distributions is less worrisome if such distributions are comparatively rare. If the variance lower bound falls off quickly as the given construction is perturbed, then the associated distribution may still be approximately self-normalizable with a good rate.\nWe have already seen that new theoretical insights in this domain can translate directly into practical applications. Thus, in addition to their inherent theoretical interest, answers to each of these questions\nmight be applied directly to the training of approximately self-normalized models in practice. We expect that self-normalization will find increasingly many applications, and we hope the results in this paper provide a first step toward a complete theoretical and empirical understanding of self-normalization in log-linear models."
    }, {
      "heading" : "A Normalizable distributions",
      "text" : "Proof of Proposition 1 (distributions close to normalizable sets are approximately normalizable).\nLet T (x, y) = T ∗(x, y) + T−(x, y), where T ∗(x, y) = arg min T (x,y):x∈S ||T (X, y)− T (x, y)||2 .\nThen,\nE ( log (∫ eη >T (X,y) dy ))2 = E ( log (∫ eη >(T∗(X,y)+T−(X,y)) dy ))2 ≤ E ( log ( eη >T̃ ∫ eη >T∗(X,y) dy\n))2 for T̃ = arg max\nT (X,y)\n||η>T (X, y)||2,\n≤ E ( log ( eη >T̃ ))2\n= (DB)2"
    }, {
      "heading" : "B Normalization and likelihood",
      "text" : ""
    }, {
      "heading" : "B.1 General bound",
      "text" : "Lemma 5. If ||η||2 ≤ δ/R, then pη(y|x) is δ-approximately normalized about logµ(Y). Proof. If ∫ eη >T (X,y) dµ(y) ≥ logµ(Y),(\nlog ∫ Y eη >T (X,y) dµ(y)− logµ(Y) )2 ≤ ( log ∫ Y e||η||2R dµ(y)− logµ(Y) )2 = ||η||22R2\n≤ δ2\nThe case where ∫ eη >T (X,y) dµ(y) ≤ logµ(Y) is analogous, instead replacing η>T (x, y) with −||η||2R. The variance result follows from the fact that every log-partition is within δ of the mean.\nProof of Theorem 2 (loss of likelihood is bounded in terms of distance from uniform). Consider the likelihood evaluated at αη̂, where α = δ/R||η̂||2. We know that 0 ≤ α ≤ 1 (if δ > Rη, then the MLE already satisfying the normalizing constraint). Additionally, pαη̂(y|x) is δ-approximately normalized. (Both follow from Lemma 5.)\nThen,\n∆` = 1\nn ∑ i [ (η̂>T (xi, yi)−A(xi, η̂))− (αη̂>T (xi, yi)−A(xi, αη̂)) ] = 1\nn ∑ i [ (1− α)η̂>T (xi, yi)−A(xi, η̂) +A(xi, αη̂) ] Because A(x, αη) is convex in α,\nA(xi, αη̂) ≤ (1− α)A(xi,0) + αA(xi, η̂) = (1− α)µ(Y) + αA(xi, η̂)\nThus,\n∆` = 1\nn ∑ i [ (1− α)η̂>T (xi, yi)−A(xi, η̂) + (1− α) logµ(Y) + αA(xi, η̂) ] = (1− α) 1\nn ∑ i [ η̂>T (xi, yi)−A(xi, η̂) + log µ(Y) ] = (1− α) 1\nn ∑ i [log pη(y|x)− log Unif(y)]\n(1− α) EKL(pη(·|X) || Unif) ≤ (\n1− δ R||η̂||2\n) EKL(pη(·|X) || Unif)"
    }, {
      "heading" : "B.2 All-nonuniform bound",
      "text" : "We make the following assumptions:\n• Labels y are discrete. That is, Y = {1, 2, . . . , k} for some k. • x ∈ H(d). That is, each x is a {0, 1} indicator vector drawn from the Boolean hypercube in q dimensions.\n• Joint feature vectors T (x, y) are just the features of x conjoined with the label y. Then it is possible to think of η as a sequence of vectors, one per class, and we can write η>T (x, y) = η>y x.\n• As in the body text, let all MLE predictions be nonuniform, and in particular let each η̂>y∗x− η̂>y x > c||η̂|| for y 6= y∗.\nLemma 6. For a fixed x, the maximum covariance between any two features xi and xj under the model evaluated at some η in the direction of the MLE:\nCov[T (X,Y )i, T (X,Y )j |X = x] ≤ 2(k − 1)e−cδ (12)\nProof. If either i or j is not associated with the class y, or associated with a zero element of x, then the associated feature (and thus the covariance at (i, j)) is identically zero. Thus we assume that i and j are both associated with y and correspond to nonzero elements of x.\nCov[Ti, Tj |X = x] = ∑ y pη(y|x)− pη(y|x)2\nSuppose y is the majority class. Then,\npη(y|x)− pη(y|x)2 = eη > y x∑\ny′ e η> y′x − e 2η>y x(∑ y′ e η> y′x )2\n= eη > y x (∑ y′ e η> y′x ) − e2η > y x(∑\ny′ e η> y′x )2\n≤ eη > y x (∑ y′ e η> y′x ) − e2η > y x\ne2η > y x = ∑ y′ 6=y e(η ′ y−ηy) >x\n≤ (k − 1)e−c||η||\nNow suppose y is not in the majority class. Then,\npη(y|x)− pη(y|x)2 ≤ p(y|x)\n= eη > y x∑\ny′ e η> y′x\n≤ e−c||η||\nThus the covariance ∑ y pη(y|x)− pη(y|x)2 ≤ 2(k − 1)e−c||η|||\nLemma 7. Suppose η = βη̂ for some β < 1. Then for a sequence of observations (x1, . . . , xn), under the model evaluated at ξ, the largest eigenvalue of the feature covariance matrix\n1\nn ∑ i [ Eξ[TT >|X = xi]− (Eθ[T |X = xi])(Eξ[T |X = xi])> ]\n(13)\nis at most q(k − 1)e−cβ||η̂|| (14)\nProof. From Lemma 6, each entry in the covariance matrix is at most (k − 1)e−c||η|| = (k − 1)e−cβ||η̂||. At most q features are nonzero active in any row of the matrix. Thus by Gershgorin’s theorem, the maximum eigenvalue of each term in Equation 13 is q(k − 1)e−cβ||η̂||, which is also an upper bound on the sum.\nProof of Proposition 3 (loss of likelihood goes as e−δ). As before, let us choose η̂δ = αη̂, with α = δ/R||η̂||2. We have already seen that this choice of parameter is normalizing. Taking a second-order Taylor expansion about η, we have\nlog pη̂δ(y|x) = log pη(y|x) + (η̂δ − η̂)>∇ log pη̂(y|x) + (η̂δ − η̂)>∇∇> log pξ(y|x)(η̂δ − η̂) = log pη̂(y|x) + (η̂δ − η̂)>∇∇> log pξ(y|x)(η̂δ − η̂)\nwhere the first-order term vanishes because η̂ is the MLE. It is a standard result for exponential families that the Hessian in the second-order term is just Equation 13. Thus we can write\n≥ log pη̂(y|x)− ||η̂δ − η̂||2q(k − 1)e−cβ||η||\n≥ log pη̂(y|x)− (1− α)2||η̂||2q(k − 1)e−cα||η||\n= log pη̂(y|x)− (||η̂|| − δ/R)2q(k − 1)e−cδ/R\nThe proposition follows.\nC Variance lower bound\nLet U0 = {β ∈ RKd : ∃β̃ ∈ Rd, βkj = β̃j , 1 ≤ k ≤ K, 1 ≤ j ≤ d}.\nLemma 8. If span (X ) = Rd, then equivalence of natural parameters is characterized by\nη ∼ η′ ⇐⇒ η − η′ ∈ U0.\nProof. For x ∈ X , denote by Pη(x) ∈ ∆K the distribution over Y . Now, suppose that η ∼ η′ and fix x ∈ X . By the definition of equivalence, we have\nPη(x)k Pη(x)k′ = Pη′(x)k Pη′(x)k′ ,\nwhich immediately implies (ηk − ηk′)T x = (η′k − η′k′) T x, whence [(ηk − η′k)− (ηk′ − η′k′)] T x = 0. Since this holds for all x ∈ X and span(X ) = Rd, we get ηk − η′k = ηk′ − η′k′ .\nThat is, if we define β̃j = η1j − η′1j , we get ηkj − η′kj = η1d − η′1j = β̃j , and η − η′ ∈ U0, as required.\nConversely, if η − η′ ∈ U0, choose an appropriate β̃. We then get\nηTk x = (η ′) T x+ β̃Tx.\nIt follows that A(η′, x) = A(η, x) + β̃Tx,\nso that ηTT (k, x)−A(η, x) = (η′)T x+ β̃Tx− [ A(η′, x) + β̃Tx ] = (η′) T x−A(η′, x)\nand the claim follows.\nThe key tool we use to prove the theorem reinterprets V ∗(η) as the norm of an orthogonal projection. We believe this may be of independent interest. To set it up, let S = L2 ( Q, RD ) be the Hilbert\nspace of square-integrable functions with respect to the input distribution p(x), define\nwj(x) = xj − Ep(x) [Xj ] and C = span (wj)1≤j≤d . We then have Lemma 9. Let Ã(η, x) = A(η, x)− Ep(x) [A(η, X)]. Then\nV ∗(η) = ∣∣∣∣∣∣Ã(η, ·)−ΠCÃ(η, ·)∣∣∣∣∣∣2\n2 .\nThe second key observation, which we again believe is of independent interest, is that under certain circumstances, we can completely replace the normalizer A(η, ·) by maxy∈Y ηTT (y, x). For this, we define\nE∞(η)(x) = max k ηTT (k, x) = max k ηTk x\nand correspondingly let Ē∞(η) = Ep(x) [E∞(η)(x)].\nProof. By Lemma 8, we have\nV ∗(η) = inf β∈Rd ∫ RKd [ A(η, x)− Ā(η)− ( βTx− βTEp(x) [X] )]2 dp(x).\nBut now, we observe that this can be rewritten with the aid of the isomorphism Rd ' C defined by the identity\nβTx− βTEp(x) [X] = ∑ j βjwj(x)\nto read\nV ∗(η) = inf f∈C ∫ Rd [ A(η, x)− Ā(η)− f ]2 dp(x) = ∣∣∣∣∣∣Ã(η, ·)−ΠCÃ(η, ·)∣∣∣∣∣∣2 2 ,\nas required.\nLemma 10. Suppose for each x ∈ X , there is a unique k∗ = k∗(x) such that k∗(x) = arg maxk ηTk x and such that for k 6= k∗, ηTk x ≤ ηTk∗x−∆ for some ∆ > 0. Then\nsup x∈X ∣∣A(η, x)− Ā(η)− [E∞(η)(x)− Ē∞(η)]∣∣ ≤ Ke−∆α. Proof. Denote by Ẽ∞ the centered version of E∞. Using the identity 1 + t ≤ et, we immediately see that\nE∞(αη)(x) ≤ A(αη, x) = αE∞(η)(x)+log 1 + ∑ k 6=k∗(x) e[η T k x−E∞(η)(x)]  ≤ E∞(αη)(x)+Ke−∆α. It follows that\nEp(x) [E∞(αη)(X)] ≤ Ep(x) [A(αη, X)] ≤ Ep(x) [E∞(αη)(X)] +Ke−∆α.\nWe thus have −Ke−∆α ≤ Ã(αη, x)− Ẽ∞(αη)(x) ≤ Ke−∆α, x ∈ X .\nThe claim follows.\nIf we let V ∗E (η) = inf\nη′∼η Varp(x)\n[ Ẽ∞(η ′, X) ] .\nCorollary 11. For α > log 2K∆ , we have\nV ∗(αη) ≥ V ∗E (η)α2 − (1 + V ∗E (η))α.\nProof. For this, observe first that if η′ ∼ η, then Ã(η′, x)2 ≥ Ẽ∞(αη′)(x)2 − 2 ∣∣∣Ẽ∞(αη′)(x)∣∣∣ ∣∣∣Ã(η′, x)− Ẽ∞(η′)(x)∣∣∣ .\nBy linearity of E∞(η′) in its η argument, and by Lemma 10, we therefore deduce Ã(η′, x)2 ≥ Ẽ∞(η′)(x)2α2 − 2Ke−∆α ∣∣∣Ẽ∞(η′)(x)∣∣∣α.\nThen using the inequality Ep(x) [|f(X)|] ≤ 1 + Varp(x) [f(X)], valid for any f ∈ L2 ( Q, RD ) with Ep(x) [f ] = 0, we thus deduce\nVarp(x) [A(αη ′, X)] ≥ Varp(x) [E∞(η′)(X)]α2 − 2Ke−∆α ( 1 + Varp(x) [E∞(η ′)(X)] ) α.\nTaking the infimum over both sides, we get\nV ∗(η) ≥ V ∗E (η)− 2Ke−∆α (1 + V ∗E (η))α.\nWe are now prepared to give the explicit example. It is defined by ηk = 0 if k > 2 and\nη1j = { −a if d = 1, a d−1 o.w.\n(15)\nand for all j, η2j =\na\nd(d− 1) , (16)\nwhere\na = √ 1− 1\nd .\nFor convenience, also define b(x) = ∑ d xd\nand observe that\nE∞(η)(x) = { ab(x) d(d−1) if xj = 1, ab(x) d−1 o.w. ,\nOur goal will be to prove that\n1 ≥ V ∗E (η) ≥ 1\n32d(d− 1) .\nThe claim will then follow by the above corollary.\nTo see that V ∗E (η) ≤ 1, we simply note that\nmax k ∣∣ηTk x∣∣ ≤ a < 1, whence Varp(x) [ ηTx ] ≤ 1 as well and we are done.\nThe other direction requires more work. To prove it, we first prove the following lemma Lemma 12. With η defined as in (15)-(16), we have\ninf η′∼η\nEp(x) [ E∞(η ′)(X)2 ] ≥ 1\n16d(d− 1) .\nProof. Suppose ηk − η′k = β ∈ Rd. We can then write\ninf η′∼η\nEp(x) [ E∞(η ′)(X)2 ]\n= inf β∈Rd\n1\n2d ∑ x∈H ∑ x∈H [ E∞(η)(x)− βTx ]2 and we therefore define\nL(β) = ∑ x∈H ∑ x∈H [ E∞(η)(x)− βTx ]2 =\n∑ x : x1=0\n[( β1 + β\nTx− a d (d− 1)\n)2 + ( ab(x)\nd− 1 − βTx\n)2] ,\nnoting that inf L = 2d · inf\nη′∼η Ep(x)\n[ E∞(η ′)(X)2 ] .\nWe therefore need to prove\nL ≥ 2 d−4\nd(d− 1) .\nHolding β2:d fixed, we note that the optimal setting of β1 is given by\nβ1 = − 1\n2 ∑ j≥2 βj + a d (d− 1) .\nWe can therefore work with the objective\nL(β) = ∑\nx : x1=0\n[( βTx− βTx¬ )2 4 + ( ab(x) d− 1 − βTx )2] ,\nwhere we have defined\nx¬j = { 0 if j = 1, 1− xj o.w.\nGrouping into {x, x¬} pairs, we end up with\nL(β2:d) = ∑\nx : x1=x2=0\n[( βTx− βTx¬ )2 2 + ( ab(x) d− 1 − βTx )2 + ( ab(x¬) d− 1 − βTx¬ )2]\nNow, supposing b(x) ≤ d−12 − 3 2 or b(x) ≥ D−1 2 + 3 2 , we have\n|b(x¬)− b(x)| = |d− 1− 2b(x)| ≥ 3.\nWe will bound the terms that satisfy this property. Indeed, supposing we fix such an x, at least one of the following must be true: either\nmax\n(( ab(x)\nd− 1 − βTx\n)2 , ( ab(x¬)\nd− 1 − βTx¬\n)2) ≥ a 2\n(d− 1)2 ,\nor ( βTx− βTx¬ )2 ≥ a2 (d− 1)2 . Indeed, suppose the first condition does not hold. Then necessarily∣∣∣∣ab(x)d− 1 − βTx ∣∣∣∣ < ad− 1 and ∣∣∣∣ab(x¬)d− 1 − βTx¬ ∣∣∣∣ < ad− 1 ,\nso that a (b(x)− 1)\nd− 1 ≤ βTx ≤ a (b(x) + 1)\nd− 1 and\na (b(x¬)− 1) d− 1 ≤ βTx ≤ a (b(x ¬) + 1) d− 1 .\nNow, if b(x) ≥ b(x¬) + 3, this immediately implies\nβTx− βTx¬ ≥ a d− 1\nand, symmetrically, if b(x¬) ≥ b(x) + 3, we get\nβTx¬ − βTx ≥ a d− 1 .\nEither way, the second inequality holds, whence the claim. Since there are at least 2d−1 − 3·2 d√\n3d 2 +1\n≥\n2d−2 choices of x satisfying the requirements of our line of reasoning, we get 2d−3 pairs, whence\nL(β2:d) ≥ 2d−4a2\n(d− 1)2 =\n2d−4\nd (d− 1) ,\nas claimed.\nWe can apply this lemma to derive a variance bound, viz. Lemma 13. With η as in (15)-(16), we have\nV ∗E (η) ≥ 1\n32d(d− 1) .\nProof. For this, observe that, with η′ being the value corresponding to η′k − ηk = β, we have\nV ∗E (η) = inf β\n1\n2d ∑ x∈H Ẽ∞(η ′)(x)2 ≥ inf β 1 2d ∑ x∈H : x1=1 Ẽ∞(η ′)(x)2.\nApplying the previous result to the (D − 1)-dimensional hypercube on which x1 = 1, we deduce\nV ∗E (η) ≥ 1 2 · 1 16(d− 1)(d− 2) =\n1 32(d− 1)(d− 2) ≥ 1 32d(d− 1) .\nProof of Theorem 4 from Lemma 13. Putting everything together, we see first that\nV ∗(αη) ≥ V ∗E (η)α2 − 4e−∆αα,\nwhere ∆ = √\n1− 1d 2(d−1) . But then this implies\nV ∗(αη) ≥ α 2\n32d(d− 1) − 4e−∆αα.\nOn the other hand, ||η||22 ≤ 2, so α2 = ||αη||22 ||η||22 ≥ ||αη|| 2 2 2 , whence\nV ∗(αη) ≥ ||αη||22\n64d(d− 1) − 4e−\n√ 1− 1\nd ||αη||2\n2(d−1) ||αη||2 ,\nwhich is the desired result."
    } ],
    "references" : [ {
      "title" : "Conditional random fields: Probabilistic models for segmenting and labeling sequence data",
      "author" : [ "J.D. Lafferty", "A. McCallum", "F.C.N. Pereira" ],
      "venue" : null,
      "citeRegEx" : "1",
      "shortCiteRegEx" : "1",
      "year" : 2001
    }, {
      "title" : "Generalized linear models",
      "author" : [ "P. McCullagh", "J.A. Nelder" ],
      "venue" : null,
      "citeRegEx" : "2",
      "shortCiteRegEx" : "2",
      "year" : 1989
    }, {
      "title" : "Fast and robust neural network joint models for statistical machine translation",
      "author" : [ "J. Devlin", "R. Zbib", "Z. Huang", "T. Lamar", "R. Schwartz", "J. Makhoul" ],
      "venue" : "Proceedings of the Annual Meeting of the Association for Computational Linguistics",
      "citeRegEx" : "3",
      "shortCiteRegEx" : "3",
      "year" : 2014
    }, {
      "title" : "Decoding with large-scale neural language models improves translation",
      "author" : [ "A. Vaswani", "Y. Zhao", "V. Fossum", "D. Chiang" ],
      "venue" : "Proceedings of the Conference on Empirical Methods in Natural Language Processing",
      "citeRegEx" : "4",
      "shortCiteRegEx" : "4",
      "year" : 2013
    }, {
      "title" : "When and why are log-linear models self-normalizing",
      "author" : [ "J. Andreas", "D. Klein" ],
      "venue" : "Proceedings of the Annual Meeting of the North American Chapter of the Association for Computational Linguistics",
      "citeRegEx" : "5",
      "shortCiteRegEx" : "5",
      "year" : 2014
    }, {
      "title" : "Neural network learning: theoretical foundations",
      "author" : [ "M. Anthony", "P. Bartlett" ],
      "venue" : null,
      "citeRegEx" : "7",
      "shortCiteRegEx" : "7",
      "year" : 2009
    }, {
      "title" : "Noise-contrastive estimation: A new estimation principle for unnormalized statistical models",
      "author" : [ "M. Gutmann", "A. Hyvärinen" ],
      "venue" : "Proceedings of the International Conference on Artificial Intelligence and Statistics",
      "citeRegEx" : "8",
      "shortCiteRegEx" : "8",
      "year" : 2010
    }, {
      "title" : "Journal of statistical planning and inference",
      "author" : [ "A. O’Hagan" ],
      "venue" : null,
      "citeRegEx" : "9",
      "shortCiteRegEx" : "9",
      "year" : 1991
    }, {
      "title" : "An introduction to sequential Monte Carlo",
      "author" : [ "A. Doucet", "N. De Freitas", "N. Gordon" ],
      "venue" : null,
      "citeRegEx" : "11",
      "shortCiteRegEx" : "11",
      "year" : 2001
    } ],
    "referenceMentions" : [ {
      "referenceID" : 0,
      "context" : "Log-linear models, a general class that includes conditional random fields (CRFs) and generalized linear models (GLMs), offer a flexible yet tractable approach modeling conditional probability distributions p(x|y) [1, 2].",
      "startOffset" : 214,
      "endOffset" : 220
    }, {
      "referenceID" : 1,
      "context" : "Log-linear models, a general class that includes conditional random fields (CRFs) and generalized linear models (GLMs), offer a flexible yet tractable approach modeling conditional probability distributions p(x|y) [1, 2].",
      "startOffset" : 214,
      "endOffset" : 220
    }, {
      "referenceID" : 2,
      "context" : "The machine translation community has recently described several procedures for training “selfnormalized” log-linear models [3, 4].",
      "startOffset" : 124,
      "endOffset" : 130
    }, {
      "referenceID" : 3,
      "context" : "The machine translation community has recently described several procedures for training “selfnormalized” log-linear models [3, 4].",
      "startOffset" : 124,
      "endOffset" : 130
    }, {
      "referenceID" : 4,
      "context" : "Previous work [5] bounds the sample complexity of self-normalizing training procedures for a restricted class of models, but leaves open the question of how self-normalization interacts with the predictive power of the learned model.",
      "startOffset" : 14,
      "endOffset" : 17
    }, {
      "referenceID" : 2,
      "context" : "The immediate motivation for this work is a procedure proposed to speed up decoding in a machine translation system with a neural-network language model [3].",
      "startOffset" : 153,
      "endOffset" : 156
    }, {
      "referenceID" : 5,
      "context" : "More usefully, all of the results presented here apply directly to trained neural nets in which the last layer only is retrained to self-normalize [7].",
      "startOffset" : 147,
      "endOffset" : 150
    }, {
      "referenceID" : 6,
      "context" : "The approach described at the beginning of this section is closely related to an alternative selfnormalization trick described based on noise-contrastive estimation (NCE) [8].",
      "startOffset" : 171,
      "endOffset" : 174
    }, {
      "referenceID" : 3,
      "context" : "In this case, empirical evidence suggests that the resulting model will also exhibit self-normalizing behavior [4].",
      "startOffset" : 111,
      "endOffset" : 114
    }, {
      "referenceID" : 7,
      "context" : "Many of these involve approximating the associated sum or integral using quadrature [9], herding [10], or Monte Carlo methods [11].",
      "startOffset" : 84,
      "endOffset" : 87
    }, {
      "referenceID" : 8,
      "context" : "Many of these involve approximating the associated sum or integral using quadrature [9], herding [10], or Monte Carlo methods [11].",
      "startOffset" : 126,
      "endOffset" : 130
    }, {
      "referenceID" : 4,
      "context" : "Generalizing a result from [5], we have: It will occasionally be instructive to consider the special case where X is the Boolean hypercube, and we will explicitly note where this assumption is made.",
      "startOffset" : 27,
      "endOffset" : 30
    }, {
      "referenceID" : 2,
      "context" : "In addition to the synthetic data, we compare our results to empirical data [3] from a self-normalized language model.",
      "startOffset" : 76,
      "endOffset" : 79
    }, {
      "referenceID" : 2,
      "context" : "Lines marked “KL=” are from synthetic data; the line marked “LM” is from [3].",
      "startOffset" : 73,
      "endOffset" : 76
    } ],
    "year" : 2017,
    "abstractText" : "Calculation of the log-normalizer is a major computational obstacle in applications of log-linear models with large output spaces. The problem of fast normalizer computation has therefore attracted significant attention in the theoretical and applied machine learning literature. In this paper, we analyze a recently proposed technique known as “self-normalization”, which introduces a regularization term in training to penalize log normalizers for deviating from zero. This makes it possible to use unnormalized model scores as approximate probabilities. Empirical evidence suggests that self-normalization is extremely effective, but a theoretical understanding of why it should work, and how generally it can be applied, is largely lacking. We prove generalization bounds on the estimated variance of normalizers and upper bounds on the loss in accuracy due to self-normalization, describe classes of input distributions that self-normalize easily, and construct explicit examples of high-variance input distributions. Our theoretical results make predictions about the difficulty of fitting self-normalized models to several classes of distributions, and we conclude with empirical validation of these predictions.",
    "creator" : "LaTeX with hyperref package"
  }
}