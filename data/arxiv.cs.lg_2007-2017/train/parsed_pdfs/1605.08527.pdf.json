{
  "name" : "1605.08527.pdf",
  "metadata" : {
    "source" : "CRF",
    "title" : "Stochastic Optimization for Large-scale Optimal Transport",
    "authors" : [ "Aude Genevay" ],
    "emails" : [ "genevay@ceremade.dauphine.fr", "mcuturi@i.kyoto-u.ac.jp", "gabriel.peyre@ceremade.dauphine.fr", "francis.bach@inria.fr" ],
    "sections" : [ {
      "heading" : "1 Introduction",
      "text" : "Many problems in computational sciences require to compare probability measures or histograms. As a set of representative examples, let us quote: bag-of-visual-words comparison in computer vision [17], color and shape processing in computer graphics [21], bag-of-words for natural language processing [11] and multi-label classification [9]. In all of these problems,\nar X\niv :1\n60 5.\n08 52\n7v 1\n[ m\nat h.\na geometry between the features (words, visual words, labels) is usually known, and can be leveraged to compare probability distributions in a geometrically faithful way. This underlying geometry might be for instance the planar Euclidean domain for 2-D shapes, a perceptual 3D color metric space for image processing or a high-dimensional semantic embedding for words. Optimal transport (OT) [23] is the canonical way to automatically lift this geometry to define a metric for probability distributions. That metric is known as the Wasserstein or earth mover’s distance. As an illustrative example, OT can use a metric between words to build a metric between documents that are represented as frequency histograms of words (see [11] for details). All the above-cited lines of work advocate, among others, that OT is the natural choice to solve these problems, and that it leads to performance improvement when compared to geometrically-oblivious distances such as the Euclidean or χ2 distances or the Kullback-Leibler divergence. However, these advantages come at the price of an enormous computational overhead. This is especially true because current OT solvers require to sample beforehand these distributions on a pre-defined set of points, or on a grid. This is both inefficient (in term of storage and speed) and counter-intuitive. Indeed, most high-dimensional computational scenarios naturally represent distributions as objects from which one can sample, not as density functions to be discretized. Our goal is to alleviate these shortcomings. We propose a class of provably convergent stochastic optimization schemes that can handle both discrete and continuous distributions through sampling.\nPrevious works. The prevalent way to compute OT distances is by solving the so-called Kantorovitch problem [10] (see Section 2 for a short primer on the basics of OT formulations), which boils down to a large-scale linear program when dealing with discrete distributions (i.e., finite weighted sums of Dirac masses). This linear program can be solved using network flow solvers, which can be further refined to assignment problems when comparing measures of the same size with uniform weights [3]. Recently, regularized approaches that solve the OT with an entropic penalization [6] have been shown to be extremely efficient to approximate OT solutions at a very low computational cost. These regularized approaches have supported recent applications of OT to computer graphics [21] and machine learning [9]. These methods apply the celebrated Sinkhorn algorithm’s [20], and can be extended to solve more exotic transportation-related problems such as the computation of barycenters [21]. Their chief computational advantage over competing solvers is that each iteration boils down to matrix-vector multiplications, which can be easily parallelized, streams extremely well on GPU, and enjoys linear-time implementation on regular grids or triangulated domains [21].\nThese methods are however purely discrete and cannot cope with continuous densities. The only known class of methods that can overcome this limitation are so-called semi-discrete solvers [1], that can be implemented efficiently using computational geometry primitives [12]. They can compute distance between a discrete distributions and a continuous density. Nonetheless, they are restricted to the Euclidean squared cost, and can only be implemented in low dimensions (2-D and 3-D). Solving these semi-discrete problems efficiently could have a significant impact for applications to density fitting with an OT loss [2] for machine learning applications, see [13]. Lastly, let us point out that there is currently no method that can compute OT distances between two continuous densities, which is thus an open problem we tackle in this article.\nContributions. This paper introduces stochastic optimization methods to compute large-scale optimal transport in all three possible settings: discrete OT, to compare a discrete vs. another discrete measure; semi-discrete OT, to compare a discrete vs. a continuous measure; and continous OT, to compare a continuous vs. another continuous measure. These methods can be used to solve both classical OT problems and their entropic-regularized versions (which enjoy faster convergence properties). We show that the discrete OT problem can be tackled using incremental algorithms, and we consider in particular the stochastic averaged gradient (SAG) method [19]. Each iteration of that algorithm requires N operations (N being the size of the supports of the input distributions), which makes it scale better in large-scale problems than the state-of-the-art Sinkhorn algorithm, while still enjoying\na convergence rate of O(1/k), k being the number of iterations. We show that the semidiscrete OT problem can be solved using averaged stochastic gradient descent (SGD), whose convergence rate is O(1/ √ k). For large-scale problems, this approach is numerically advantageous over the brute force approach consisting in sampling first the continuous density to solve next a discrete OT problem. Lastly, for continuous optimal transport, we propose a novel method which makes use of an expansion of the dual variables in a reproducing kernel Hilbert space (RKHS). This allows us for the first time to compute with a converging algorithm OT distances between two arbitrary densities, under the assumption that the two potentials belong to such an RKHS.\nNotations. In the following we consider two metric spaces X and Y. We denote by M1+(X ) the set of positive Radon probability measures on X , and C(X ) the space of continuous functions on X . Let µ ∈M1+(X ), ν ∈M1+(Y), we define\nΠ(µ, ν) def. = { π ∈M1+(X × Y) ; ∀(A,B) ⊂ X × Y, π(A× Y) = µ(A), π(X ×B) = ν(B) } the set of joint probability measures on X ×Y with marginals µ and ν. The Kullback-Leibler divergence between joint probabilities is defined as\n∀(π, ξ) ∈M1+(X × Y)2, KL(π|ξ) def. = ∫ X×Y ( log ( dπ dξ (x, y) ) − 1 ) dπ(x, y),\nwhere we denote dπdξ the relative density of π with respect to ξ, and by convention KL(π|ξ) def. = +∞ if π does not have a density with respect to ξ. The Dirac measure at point x is δx. For a set C, ιC(x) = 0 if x ∈ C and ιC(x) = +∞ otherwise. The probability simplex of N bins is ΣN = { µ ∈ RN+ ; ∑ i µi = 1 } . Element-wise multiplication of vectors is denoted by\nand K> denotes the transpose of a matrix K. We denote 1N = (1, . . . , 1)> ∈ RN and 0N = (0, . . . , 0)> ∈ RN ."
    }, {
      "heading" : "2 Optimal Transport: Primal, Dual and Semi-dual Formulations",
      "text" : "We consider the optimal transport problem between two measures µ ∈ M1+(X ) and ν ∈ M1+(Y), defined on metric spaces X and Y. No particular assumption is made on the form of µ and ν, we simply assume that they both can be sampled from to be able to apply our algorithms.\nPrimal, Dual and Semi-dual Formulations. The Kantorovich formulation [10] of OT and its entropic regularization [6] can be conveniently written in a single convex optimization problem as follows\n∀(µ, ν) ∈M1+(X )×M1+(Y), Wε(µ, ν) def. = min\nπ∈Π(µ,ν) ∫ X×Y\nc(x, y)dπ(x, y) + εKL(π|µ⊗ ν). (Pε)\nHere c ∈ C(X × Y) and c(x, y) should be interpreted as the “ground cost” to move a unit of mass from x to y. This c is typically application-dependent, and reflects some prior knowledge on the data to process. We refer to the introduction for a list of previous work where various examples (in imaging, vision, graphics or machine learning) of such costs are given.\nWhen X = Y , ε = 0 and c = dp for p ≥ 1, where d is a distance on X , then W0(µ, ν) 1 p is known as the p-Wasserstein distance onM1+(X ). Note that this definition can be used for any type of measure, both discrete and continuous. When ε > 0, problem (Pε) is strongly convex, so that the optimal π is unique, and algebraic properties of the KL regularization result in computations that can be tackled using the Sinkhorn algorithm [6].\nFor any c ∈ C(X × Y), we define the following constraint set\nUc def. = {(u, v) ∈ C(X )× C(Y) ; ∀(x, y) ∈ X × Y, u(x) + v(y) ≤ c(x, y)} ,\nand define its indicator function as well as its “smoothed” approximation\nιεUc(u, v) def. = { ιUc(u, v) if ε = 0, ε ∫ X×Y exp( u(x)+v(y)−c(x,y) ε )dµ(x)dν(y) if ε > 0.\n(1)\nFor any v ∈ C(Y), we define its c-transform and its “smoothed” approximation\n∀x ∈ X , vc,ε(x) def.=  miny∈Y c(x, y)− v(y) if ε = 0,−ε log (∫Y exp( v(y)−c(x,y)ε )dν(y)) if ε > 0. (2) The proposition below describes two dual problems. It is central to our analysis and\npaves the way for the application of stochastic optimization methods.\nProposition 2.1 (Dual and semi-dual formulations). For ε ≥ 0, one has\nWε(µ, ν) = max u∈C(X ),v∈C(Y)\nFε(u, v) def. = ∫ X u(x)dµ(x) + ∫ Y v(y)dν(y)− ιεUc(u, v), (Dε)\n= max v∈C(Y)\nHε(v) def. = ∫ X vc,ε(x)dµ(x) + ∫ Y v(y)dν(y)− ε, (Sε)\nwhere ιεUc is defined in (1) and v c,ε in (2). Furthermore, u solving (Dε) is recovered from an optimal v solving (Sε) as u = vc,ε. For ε > 0, the solution π of (Pε) is recovered from any (u, v) solving (Dε) as dπ(x, y) = exp(u(x)+v(y)−c(x,y)ε )dµ(x)dν(y). Proof. Problem (Dε) is the convex dual of (Pε), and is derived using Fenchel-Rockafellar’s theorem. The relation between u and v is obtained by writing the first order optimality condition for v in (Dε). Plugging this expression back in (Dε) yields (Sε).\nProblem (Pε) is called the primal while (Dε) is its associated dual problem. We refer to (Sε) as the “semi-dual” problem, because in the special case ε = 0, (Sε) boils down to the so-called semi-discrete OT problem [1]. Both dual problems are concave maximization problems. The optimal dual variables (u, v)—known as Kantorovitch potentials—are not unique, since for any solution (u, v) of (Dε), (u+ λ, v − λ) is also a solution for any λ ∈ R. When ε > 0, they can be shown to be unique up to this scalar translation [6]. We refer to Appendix A for a discussion (and proofs) of the convergence of the solutions of (Pε), (Dε) and (Sε) towards those of (P0), (D0) and (S0) as ε→ 0.\nA key advantage of (Sε) over (Dε) is that, when ν is a discrete density (but not necessarily µ), then (Sε) is a finite-dimensional concave maximization problem, which can thus be solved using stochastic programming techniques, as highlighted in Section 4. By contrast, when both µ and ν are continuous densities, these dual problems are intrinsically infinite dimensional, and we propose in Section 5 more advanced techniques based on RKHSs.\nStochastic Optimization Formulations. The fundamental property needed to apply stochastic programming is that both dual problems (Dε) and (Sε) must be rephrased as minimizing expectations:\n∀ε > 0, Fε(u, v) = EX,Y [fε(X,Y, u, v)] and ∀ε ≥ 0, Hε(v) = EX [hε(X, v)] , (3)\nwhere the random variables X and Y are independent and distributed according to µ and ν respectively, and where, for (x, y) ∈ X × Y and (u, v) ∈ C(X )× C(Y),\n∀ε > 0, fε(x, y, u, v) def.= u(x) + v(y)− ε exp (u(x) + v(y)− c(x, y)\nε\n) ,\n∀ε ≥ 0, hε(x, v) def.= ∫ Y v(y)dν(y) + vc,ε(x)− ε.\nThis reformulation is at the heart of the methods detailed in the remainder of this article. Note that the dual problem (Dε) cannot be cast as an unconstrained expectation maximization problem when ε = 0, because of the constraint on the potentials which arises in that case."
    }, {
      "heading" : "3 Discrete Optimal Transport",
      "text" : "We assume in this section that both µ and ν are discrete measures, i.e. finite sums of Diracs, of the form µ = ∑I i=1 µiδxi and ν = ∑J j=1 νjδyj , where (xi)i ⊂ X and (yj)j ⊂ Y, and the histogram vector weights are µ ∈ ΣI and ν ∈ ΣJ . These discrete measures may come from the evaluation of continuous densities on a grid, counting features in a structured object, or be empirical measures based on samples. This setting is relevant for several applications, including all known applications of the earth mover’s distance. We show in this section that our stochastic formulation can prove extremely efficient to compare measures with a large number of points.\nDiscrete Optimization and Sinkhorn. In this setup, the primal (Pε), dual (Dε) and semi-dual (Sε) problems can be rewritten as finite-dimensional optimization problems involving the cost matrix c ∈ RI×J+ defined by ci,j = c(xi, yj):\nWε(µ, ν) = min π∈RI×J+\n{∑ i,j ci,jπi,j + ε ∑ i,j ( log πi,j νiµj − 1 ) πi,j ; π1J = µ,π >1I = ν } ,\n(P̄ε) = max\nu∈RI ,v∈RJ\n∑ i uiµi + ∑ j vjνj − ε ∑ i,j exp ( ui+vj−ci,j ε ) µiνj , (for ε > 0) (D̄ε)\n= max v∈RJ\nH̄ε(v) = ∑ i∈I h̄ε(xi,v)µi, where (S̄ε)\nh̄ε(x,v) = ∑ j∈J vjνj + { −ε log(∑j∈J exp(vj−c(x,yj)ε )νj)− ε if ε > 0, minj (c(x, yj)− vj) if ε = 0,\n(4)\nThe state-of-the-art method to solve the discrete regularized OT (i.e. when ε > 0) is Sinkhorn’s algorithm [6, Alg.1], which has linear convergence rate [8]. It corresponds to a block coordinate maximization, successively optimizing (D̄ε) with respect to either u or v. Each iteration of this algorithm is however costly, because it requires a matrix-vector multiplication. Indeed, this corresponds to a “batch” method where all the samples (xi)i and (yj)j are used at each iteration, which has thus complexity O(N2) where N = max(I, J). We now detail how to alleviate this issue using online stochastic optimization methods.\nIncremental Discrete Optimization when ε > 0. Stochastic gradient descent (SGD), in which an index k is drawn from distribution µ at each iteration can be used to minimize the finite sum that appears in in S̄ε. The gradient of that term h̄ε(xk, ·) is\n∇vh̄ε(x,v) = ν − χε(c(x,y`)−v`)` , where ∀ε > 0, (χ ε r)j def. = e− rj ε νj (∑ ` e − r`ε ν` )−1 .\nThis gradient can then be used as a proxy for the full gradient in a standard gradient ascent step to maximize H̄ε. Note that in the case where ε = 0, one can define χ0r def. = earg min` r` , where e` is the `th canonical basis vector. When the set arg min` r` is not a singleton, one can arbitrarily choose any element from this set, and ∇vh̄ε(x,v) is then a sub-gradient of the convex function h̄ε(x, ·).\nAlgorithm 1 SAG for Discrete OT Input: C Output: v v← 0J , d← 0J , ∀i,gi ← 0J for k = 1, 2, . . . do\nSample i ∈ {1, 2, . . . , I} uniform. d← d− gi gi ← µi∇vh̄ε(xi,v) d← d + gi ; v← v + Cd\nend for When ε > 0, the finite sum appearing in (S̄ε) suggests to use incremental gradient methods— rather than purely stochastic ones—which are known to converge faster than SGD. We propose to use the stochastic averaged gradient (SAG) [19]. As SGD, SAG operates at each iteration by sampling a point xk from µ, to compute the gradient corresponding to that sample for the current estimate v. Unlike SGD, SAG keeps in memory a copy of that gradient, until that particular point is sampled again, at which point the copy is updated. Unlike SGD, SAG applies a fixed length update, in the direction of the average of all gradients stored so far, which provides a better proxy\nof the gradient corresponding to the entire sum. This improves the convergence rate to |H̄ε(v?ε)− H̄ε(vk)| = O(1/k), where v?ε is a minimizer of H̄ε, at the expense of storing the gradient for each of the I points. This expense can be mitigated by considering mini-batches instead of individual points. Note finally that the SAG algorithm is adaptive to strongconvexity and will be linearly convergent around the optimum. The pseudo-code for SAG is provided in Algorithm 1, and we defer more details on SGD for Section 4, in which it will be shown to play a crucial role. Note that the Lipschitz constant of all these terms is upperbounded by L = maxi µi/ε.\nNumerical Illustrations on Bags of Word-Embeddings. Comparing texts using a Wasserstein distance on their representations as clouds of word embeddings (so called word mover’s distances) has been recently shown to yield state-of-the-art accuracy for text classification [11]. The authors of [11] have however highlighted that this accuracy comes at a large computational cost. We test our stochastic approach to discrete OT in this scenario, using the complete works of 35 authors1. We use Glove word embeddings [14], namely X = Y = R300. We discard all most frequent 1, 000 words that appear at the top of the file glove.840B.300d provided on the authors’ website. We sample N = 20, 000 words (found within the remaining huge dictionary of relatively rare words) from each authors’ complete work. Each author is thus represented as a cloud of 20, 000 points in R300. The cost function c between the word embeddings is the squared-Euclidean distance, re-scaled so that it has a unit empirical median on 2, 000 points sampled randomly among all vector embeddings. We set ε to 0.01. We compute all (35 × 34/2 = 595) pairwise regularized Wasserstein distances using both the Sinkhorn algorithm and SAG. Following the recommendations in [19], SAG’s stepsize is tested for 3 different settings, 1/L, 3/L and 5/L. The convergence of each algorithm is measured by computing the `1 norm of the gradient of the full sum (which also corresponds to the marginal violation of the primal transport solution that can be recovered with these dual variables[6]), as well as the `2 norm of the deviation to the optimal scaling found after 4, 000 passes for any of the three methods. Results are presented in Fig. 1 and suggest that SAG can be more than twice faster than Sinkhorn on average for all tolerance thresholds. Note finally that SAG retains exactly the same parallel properties as Sinkhorn: all of these computations can be streamlined on GPUs. We used 4 Tesla K80 cards to compute both SAG and Sinkhorn results. For each distance computation, all 4, 000 passes (far more than is needed to approximate only the distance) take less than 2 minutes."
    }, {
      "heading" : "4 Semi-Discrete Optimal Transport",
      "text" : "In this section, we assume that µ is an arbitrary measure (in particular, it needs not to be discrete) and that ν = ∑J j=1 νjδyj is a discrete measure. This corresponds to the semi-discrete OT problem [1, 12]. The semi-dual problem (Sε) is then a finite-dimensional maximization problem, written in expectation form as Wε(µ, ν) = max v∈RJ EX [ h̄ε(X,v) ] where X ∼ µ and h̄ε is defined in (4). Stochastic Semi-discrete Optimization. Since the expectation is taken over an arbitrary measure, neither Sinkhorn algorithm nor incremental algorithms such as SAG can be used. An alternative is to approximate µ by an empirical measure µ̂N def. = 1N ∑N i=1 δxi where (xi)i=1,...,N are i.i.d samples from µ, and computing Wε(µ̂N , ν) using the discrete methods (Sinkhorn or SAG) detailed in Section 3. However this introduces a discretization noise in the solution as the discrete problem is now different from the original one and thus has a different solution. Averaged SGD on the other hand does not require µ to be discrete and is thus perfectly adapted to this semi-discrete setting. The algorithm is detailed in\n1 The list of authors we consider is: Keats, Cervantes, Shelley, Woolf, Nietzsche, Plutarch, Franklin, Coleridge, Maupassant, Napoleon, Austen, Bible, Lincoln, Paine, Delafontaine, Dante, Voltaire, Moore, Hume, Burroughs, Jefferson, Dickens, Kant, Aristotle, Doyle, Hawthorne, Plato, Stevenson, Twain, Irving, Emerson, Poe, Wilde, Milton, Shakespeare.\nAlgorithm 2 (the expression for ∇h̄ε being given in Equation 4). The convergence rate is O(1/ √ k) thanks to averaging ṽk [15].\nAlgorithm 2 Averaged SGD for Semi-Discrete OT Input: C Output: v ṽ← 0J , v← ṽ for k = 1, 2, . . . do\nSample xk from µ ṽ← ṽ + C√\nk ∇vh̄ε(xk, ṽ)\nv← 1k ṽ + k−1n v end for\nNumerical Illustrations. Numerical simulations are performed in X = Y = R3. Here µ is a Gaussian mixture (i.e. a continuous density) and the measure ν = 1J ∑J j=1 δyj with J = 10 and (xj)j are i.i.d. samples drawn from another gaussian mixture. Each mixture is composed of three gaussians whose means are drawn randomly in [0, 1]3, and their correlation matrices are constructed as Σ = 0.01(RT + R) + 3I3 where R is a 3 × 3 matrix with random entries in [0, 1]. In the following, we denote v?ε a solution of (Sε), which is approximated numerically by running SGD with for a large enough number of iterations.\nFigure 2 (a) shows the evolution of ‖vk − v?0‖2 / ‖v?0‖2 as a function of k. It highlights the influence of the regularization parameters ε on the iterates of SGD. While the regularized iterates converge faster, they do not converge to the correct unregularized solution. This figure also illustrates the convergence theorem of solution of (Sε) toward those (S0) when ε→ 0, which can be found in Appendix A.\nFigure 2 (b) shows the evolution of ‖vk − v?ε‖2 / ‖v?ε‖2 averaged over 40 runs as a function of k, for a fixed regularization parameter value ε = 10−2. It compares SGD to SAG using different numbers N of samples for the empirical measures µ̂N . While SGD converges to the true solution of the semi-discrete problem, the solution computed by SAG is biased because of the approximation error which comes from the discretization of µ. This error decreases when the sample size N is increased, as the approximation of µ by µ̂N becomes more accurate."
    }, {
      "heading" : "5 Continuous optimal transport using RKHS",
      "text" : "In the case where neither µ nor ν are discrete, problem (Sε) is infinite-dimensional, so it cannot be solved directly using stochastic SGD. We propose in this section to solve the initial dual problem (Dε), using expansions of the dual variables in two reproducing kernel Hilbert\nspaces (RKHS). Recall that contrarily to the methods from previous sections, we can only solve the regularized problem here (i.e. ε > 0), since (Dε) cannot be cast as an expectation maximization problem when ε = 0.\nStochastic Continuous Optimization. We consider two reproducing kernel Hilbert spaces (RKHS) H and G defined on X and on Y, with kernels κ and `, associated with norms ‖ · ‖H and ‖ · ‖G . Recall the two main properties of RKHS: (a) if u ∈ H, then u(x) = 〈u, κ(·, x)〉H and (b) κ(x, x′) = 〈κ(·, x), κ(·, x′)〉H.\nThe dual problem (Dε) is conveniently re-written in (3) as the maximization of the expectation of fε(X,Y, u, v) with respect to the random variables (X,Y ) ∼ µ⊗ ν. The SGD algorithm applied to this problem reads, starting with u0 = 0 and v0 = 0,\n(uk, vk) def. = (uk−1, vk−1) + C√ k ∇fε(xk, yk, uk−1, vk−1) ∈ H × G, (5)\nwhere (xk, yk) are i.i.d. samples from µ ⊗ ν. The following proposition shows that these (uk, vk) iterates can be expressed as finite sums of kernel functions, and that the coefficients of these expansions enjoy a particularly simple recursion formula.\nProposition 5.1. The iterates (uk, vk) defined in (5) satisfy\n(uk, vk) def. = k∑ i=1 αi(κ(·, xi), `(·, yi)), where αi def.= ΠBr ( C√ i ( 1− e ui−1(xi)+vi−1(yi)−c(xi,yi) ε )) ,\n(6) where (xi, yi)i=1...k are i.i.d samples from µ⊗ ν and ΠBr is the projection on the centered ball of radius r. If the solutions of (Dε) are in the H × G and if r is large enough, the iterates (uk,vk) converge to a solution of (Dε). Proof. Rewriting u(x) and v(y) as scalar products in fε(X,Y, u, v) yields\nfε(x, y, u, v) = 〈u, κ(x, ·)〉H + 〈v, `(y, ·)〉G − ε exp ( 〈u, κ(x, ·)〉H + 〈v, `(y, ·)〉G − c(x, y)\nε\n) .\nPlugging this formula in iteration (5) yields : (uk, vk) = uk−1 + αk(κ(·, xk), `(·, yk)) ,where αk is defined in (6). Since the parameters (αi)i<k are not updated at iteration k, we get the announced formula. Putting a bound on the iterates of α by projecting on Br ensures convergence [7].\nThe algorithm for kernel SGD is outlined in Algorithm 3. Both potentials u and v are approximated by a linear combination of kernel functions. The main cost is the computation of uk−1(xk) = ∑k−1 i=1 αiκ(xk, xi) and vk−1(yk) = ∑k−1 i=1 αi`(yk, yi) which yields complexity O(k2). Several methods exist to alleviate the running time complexity of kernel algorithms, e.g. random Fourier features [16] or incremental incomplete Cholesky decomposition [24].\nAlgorithm 3 Kernel SGD for continuous OT Input: C, kernels κ and ` Output: (αk, xk, yk)k=1,...\nfor k = 1, 2, . . . do Sample xk from µ Sample yk from ν uk−1(xk) def. = ∑k−1 i=1 αiκ(xk, xi)\nvk−1(yk) def. = ∑k−1 i=1 αi`(yk, yi) αk def. = C√\nk\n( 1− e uk−1(xk)+vk−1(yk)−c(xk,yk) ε ) end for\nKernels that are associated with dense RHKS are called universal [22] and thus can approach any arbitrary potential. When working over Euclidean spaces X = Y = Rd for some d > 0, a natural choice of universal kernel is the kernel defined by κ(x, x′) = exp(−‖x−x\n′‖2 σ2 ). Tuning the bandwidth σ is\ncrucial to obtain a good convergence of the algorithm.\nFinally, let us note that, while entropy regularization of the primal problem (Pε) was instrumental to be able to apply semidiscrete methods in Sections 3 and 4, this is not the case here. Indeed, since the kernel SGD algorithm is applied to the dual (Dε), it is possible to replace KL(π|µ⊗ ν) appearing in (Pε) by other regularizing divergences. A typical example would be a χ2 divergence∫ X×Y( dπ dµdν (x, y))\n2dµ(x)dν(y) (with positivity constraints on π). Numerical Illustrations. We consider optimal transport in 1D between a Gaussian µ and a Gaussian mixture ν whose densities are represented in Figure 3 (a). Since there is no existing benchmark for continuous transport, we use the solution of the semi-discrete problem Wε(µ, ν̂N ) with N = 103 computed with SGD as a proxy for the solution and we denote it by û?. We focus on the convergence of the potential u, as it is continuous in both problems contrarily to v. Figure 3 (b) represents the plot of ‖uk − û?‖2/‖û?‖2 where u is the evaluation of u on a sample (xi)i=1...N ′ drawn from µ. This gives more emphasis to the norm on points where µ has more mass. The convergence is rather slow but still noticeable. The iterates uk are plotted on a grid for different values of k in Figure 3 (c), to emphasize the convergence to the proxy û?. We can see that the iterates computed with the RKHS converge faster where µ has more mass, which is actually where the value of u has the greatest impact in Fε (u being integrated against µ).\nConclusion We have shown in this work that the computations behind (regularized) optimal transport can be considerably alleviated, or simply enabled, using a stochastic optimization approach. In the discrete case, we have shown that incremental gradient methods can surpass the Sinkhorn algorithm in terms of efficiency, taken for granted that the (constant) stepsize has been correctly selected, which should be possible in practical applications. We have\nalso proposed the first known methods that can address the challenging semi-discrete and continuous cases. All of these three settings can open new perspectives for the application of OT to high-dimensional problems."
    }, {
      "heading" : "Acknowledgement",
      "text" : "The work of G. Peyré has been supported by the European Research Council (ERC project SIGMA-Vision). The work of A. Genevay has been supported by Région Ile-de-France. M. Cuturi gratefully acknowledges the support of JSPS young research A grant 26700002."
    }, {
      "heading" : "A Convergence of (Sε) as ε→ 0",
      "text" : "The convergence of the solution of (Pε) toward a solution of (P0) as ε→ 0 is proved in [4]. The convergence of solutions of (Dε) toward solutions of (D0) as ε → 0 is proved for the special case of discrete measures in [5]. To the best of our knowledge, the behavior of (Sε) has not been studied in the literature, and we propose a convergence result in the case where ν is discrete, which is the setting in which this formulation is most advantageous.\nProposition A.1. We assume that ∀y ∈ Y, c(·, y) ∈ L1(µ), that ν = ∑Jj=1 νjδyj , and we fix x0 ∈ X ,. For all ε > 0, let vε be the unique solution of (Sε) such that vε(x0) = 0. Then (vε)ε is bounded and all its converging sub-sequences for ε→ 0 are solutions of (S0).\nWe first prove a useful lemma.\nLemma A.2. If ∀y, x 7→ c(x, y) ∈ L1(µ) then Hε converges pointwise to H0.\nProof. Let αj(x) def. = vj − c(x, yj) and j? def.= arg maxj αj(x). On the one hand, since ∀j, αj(x) ≤ αj?(x) we get\nε log( J∑ j=1 e αj(x) ε νj) = ε log(e αj? (x) ε J∑ j=1 e αj(x)−αj? (x) ε νj) ≤ αj?(x) + ε log( J∑ j=1 νj) = αj?(x) (7)\nOn the other hand, since log is increasing and all terms in the sum are non negative we have\nε log( J∑ j=1 e αj(x) ε νj) ≥ ε log(e αj? (x) ε νj?) = αj?(x) + ε log(νj?) ε→0−→ αj?(x) (8)\nHence ε log( ∑J j=1 e αj(x) ε νj) ε→0−→ αj?(x) and ε log( ∑J j=1 e αj(x)\nε νj) ≤ αj?(x). Since we assumed x 7→ c(x, yj) ∈ L1(µ), then αj? ∈ L1(µ) and by dominated convergence we get that Hε(v) ε→0−→ H0(v).\nProof of Proposition A.1. First, let’s prove that (vε)ε has a converging subsequence. With similar computations as in Proposition 2.1 we get that vε(yi) = −ε log( ∫ X e uε(x)−c(x,yi) ε dµ(x)). We denote by ṽε the c-transform of uε such that ṽε(yi) = minx∈X c(x, yi) − uε(x). From standard results on optimal transport (see [18], p.11) we know that | ṽε(yi) − ṽε(yj) |≤ ω(‖yi − yj‖) where ω is the modulus of continuity of the cost c. Besides, using once again the soft-max argument we can bound | vε(y)− ṽε(y) | by some constant C.\nThus we get that :\n| vε(yi)− vε(yj) | ≤ | vε(yi)− ṽε(yi) | + | ṽε(yi)− ṽε(yj) | + | ṽε(yj)− vε(yj) | (9) ≤ C + ω(‖yi − yj‖) + C (10)\nBesides, the regularized potentials are unique up to an additive constant. Hence we can set without loss of generality vε(y0) = 0. So from the previous inequality yields :\nvε(yi) ≤ 2C + ω(‖yi − y0‖) (11)\nSo vε is bounded on RJ which is a compact set and thus we can extract a subsequence which converges to a certain limit that we denote by v̄.\nLet v? ∈ arg maxvH0. To prove that v̄ is optimal, it suffices to prove thatH0(v?) ≤ H0(v̄). By optimality of vε,\nHε(v ?) ≤ Hε(vε) (12)\nThe term on the left-hand side of the inequality converges to H0(v?) since Hε converges pointwise to H0. We still need to prove that the right-hand term converges to H0(v̄).\nBy the Mean Value Theorem, there exists ṽε def. = (1− tε)vε + tεv̄ for some tε ∈ [0, 1] such that | Hε(vε)−Hε(v̄) |≤ ‖∇Hε(ṽε)‖ ‖vε − v̄‖ (13)\nThe gradient of Hε reads ∇vHε(v) = ν − π(v) (14) where πi(v) = ∫ X e vi−c(x,yi) ε νidµ(x)∫\nX ∑J j=1 e vj−c(x,yj) ε νjdµ(x)\nIt is the difference of two elements in the simplex thus it is bounded by a constant C independently of ε.\nUsing this bound in (13) get\nHε(v̄)− C ‖vε − v̄‖ ≤ Hε(vε) ≤ Hε(v̄) + C ‖vε − v̄‖ (15)\nBy pointwise convergence of Hε we know that Hε(v̄) → H0(v̄), and since v̄ is a limit point of vε we can conclude that the left and right hand term of the inequality converge to H0(v̄). Thus we get Hε(vε)→ H0(v̄)."
    } ],
    "references" : [ ],
    "referenceMentions" : [ ],
    "year" : 2016,
    "abstractText" : "Optimal transport (OT) defines a powerful framework to compare probability distri-<lb>butions in a geometrically faithful way. However, the practical impact of OT is still<lb>limited because of its computational burden. We propose a new class of stochastic opti-<lb>mization algorithms to cope with large-scale problems routinely encountered in machine<lb>learning applications. These methods are able to manipulate arbitrary distributions<lb>(either discrete or continuous) by simply requiring to be able to draw samples from them,<lb>which is the typical setup in high-dimensional learning problems. This alleviates the<lb>need to discretize these densities, while giving access to provably convergent methods<lb>that output the correct distance without discretization error. These algorithms rely<lb>on two main ideas: (a) the dual OT problem can be re-cast as the maximization of an<lb>expectation ; (b) entropic regularization of the primal OT problem results in a smooth<lb>dual optimization optimization which can be addressed with algorithms that have a<lb>provably faster convergence. We instantiate these ideas in three different setups: (i)<lb>when comparing a discrete distribution to another, we show that incremental stochastic<lb>optimization schemes can beat Sinkhorn’s algorithm, the current state-of-the-art finite<lb>dimensional OT solver; (ii) when comparing a discrete distribution to a continuous<lb>density, a semi-discrete reformulation of the dual program is amenable to averaged<lb>stochastic gradient descent, leading to better performance than approximately solving<lb>the problem by discretization ; (iii) when dealing with two continuous densities, we<lb>propose a stochastic gradient descent over a reproducing kernel Hilbert space (RKHS).<lb>This is currently the only known method to solve this problem, apart from computing<lb>OT on finite samples. We backup these claims on a set of discrete, semi-discrete and<lb>continuous benchmark problems.",
    "creator" : "LaTeX with hyperref package"
  }
}